<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Data Entry</title>
    
    <style>
/* --- NEW: Global Background and Form Transparency Styles --- */

/* Apply the colorful gradient background to the entire body or main application container */
body {
    background-color: #77aa77;
/* The custom SVG gradient background */

background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100%25' height='100%25' viewBox='0 0 2 1'%3E%3Cdefs%3E%3ClinearGradient id='a' gradientUnits='userSpaceOnUse' x1='0' x2='0' y1='0' y2='1'%3E%3Cstop offset='0' stop-color='%2377aa77'/%3E%3Cstop offset='1' stop-color='%234fd'/%3E%3C/linearGradient%3E%3ClinearGradient id='b' gradientUnits='userSpaceOnUse' x1='0' y1='0' x2='0' y2='1'%3E%3Cstop offset='0' stop-color='%23cf8' stop-opacity='0'/%3E%3Cstop offset='1' stop-color='%23cf8' stop-opacity='1'/%3E%3C/linearGradient%3E%3ClinearGradient id='c' gradientUnits='userSpaceOnUse' x1='0' y1='0' x2='2' y2='2'%3E%3Cstop offset='0' stop-color='%23cf8' stop-opacity='0'/%3E%3Cstop offset='1' stop-color='%23cf8' stop-opacity='1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='0' y='0' fill='url(%23a)' width='2' height='1'/%3E%3Cg fill-opacity='0.5'%3E%3Cpolygon fill='url(%23b)' points='0 1 0 0 2 0'/%3E%3Cpolygon fill='url(%23c)' points='2 1 2 0 0 0'/%3E%3C/g%3E%3C/svg%3E");
background-attachment: fixed; /* Ensures the background stays put as the user scrolls */
background-size: cover;
}

/* Form Container with Transparency Control (UPDATED FOR GLASSMORPHISM) */
/* Apply this class to your main form or card container in HTML (e.g., <div class="form-container">) */
.form-container {
    /* Set CSS custom properties for manual transparency and blur control (decimal values) */
    --form-bg-opacity: 0.25; /* Adjust 0.0 to 1.0 for background transparency */
    --form-blur-value: 12px; /* Adjust with 'px' unit for blur effect (e.g., 12px) */

    /* Uses RGBA for a transparent background color (e.g., white with opacity) */
    background-color: rgba(255, 255, 255, var(--form-bg-opacity));

    /* Key for Glassmorphism: Backdrop Blur Filter */
    backdrop-filter: blur(var(--form-blur-value));
    -webkit-backdrop-filter: blur(var(--form-blur-value)); /* For Safari */

    /* Frosted look: Subtle border and rounded corners */
    border: 1px solid rgba(255, 255, 255, 0.18); /* Faint white border */
    border-radius: 12px; /* Rounded corners */

    /* Optional: Slight 3D effect */
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); 
}

/* --- END NEW STYLES --- */

/* Legacy grid styling */
.legacy-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 columns for the first row */
    gap: 16px;
}

/* For larger screens, the grid pattern will adjust to fit two items per row after the first row */
.legacy-grid > div:nth-child(n + 4):nth-child(-n + 8) {
    grid-column: span 1;
}

/* Delay Reason should span full width */
.legacy-grid > div:last-child {
    grid-column: span 3;
}

/* Responsive adjustments for smaller screens */
@media (max-width: 768px) {
    .legacy-grid {
        grid-template-columns: 1fr 1fr;
    }

    .legacy-grid > div:nth-child(n + 4):nth-child(-n + 8) {
        grid-column: span 1;
    }

    .legacy-grid > div:last-child {
        grid-column: span 2;
    }
}

/* Custom styles for the disabled Delay Reason field */
.disabled-field {
    background-color: #ffcccc;
    color: #a3a3a3;
}

/* Form group container */
.form-group {
    position: relative;
    margin-bottom: 1.5rem;
}

/* Input and textarea styles */
.form-input {
    width: 100%;
    padding: 8px 0;
    font-size: 14px;
    border: none;
    border-bottom: 2px solid #ccc;
    background-color: transparent;
    outline: none;
    transition: border-color 0.3s ease;
}

/* Focus and valid states */
.form-input:focus,
.form-input:not(:placeholder-shown) {
    border-bottom-color: #3b82f6;
}

/* New border styles for success and failure */
.border-success {
    border-bottom: 2px solid green !important;
}

.border-failure {
    border-bottom: 2px solid red !important;
}

/* Label styles */
.form-label {
    position: absolute;
    top: 8px;
    left: 0;
    font-size: 14px;
    color: #666;
    transition: all 0.3s ease;
    pointer-events: none;
}

/* Move label up when input is focused or has content */
.form-input:focus ~ .form-label,
.form-input:not(:placeholder-shown) ~ .form-label {
    top: -12px;
    font-size: 12px;
    color: #3b82f6;
}

/* New class for floating labels */
.form-label.floating {
    top: -12px;
    font-size: 12px;
    color: #3b82f6;
}

/* Disabled field styles */
.disabled-field {
    background-color: #ffcccc;
    color: #a3a3a3;
}

/* Remove form-input class from the label */
#delayReasonLabel {
    display: block;
    font-size: 14px;
    color: #000000;
    margin-bottom: 8px;
}

/* Added styles for icons */
.icon-with-text {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
}

.icon-success {
    color: green;
}

.icon-failure {
    color: red;
}

/* Styles for the custom modal box */
/* Updated to include #teamsAlertModal, #deleteAllConfirmationModal */
#teamsAlertModal,
#deleteConfirmationModal,
#teamsFailModal,
#clearAfterShareConfirmation,
#deleteAllConfirmationModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent black overlay */
    display: none; /* Hidden by default */
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 24px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-width: 90%;
    width: 400px;
    text-align: center;
    position: relative;
    border-top: 5px solid #3b82f6; /* Accent color */
}

/* Styling for the close button */
.close-button {
    position: absolute;
    top: 10px;
    right: 10px;
    cursor: pointer;
    font-size: 20px;
    color: #9ca3af; /* Gray color */
}

.close-button:hover {
    color: #6b7280;
}

/* Button styles for main actions */
.icon-button-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    background-color: #f3f4f6;
    border: 1px solid #d1d5db;
}

.icon-button-container:hover {
    background-color: #e5e7eb;
}

.icon-button-container-new {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    padding: 10px 4px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    background-color: #f9fafb;
    border: 1px solid #f3f4f6;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

.icon-button-container-new:hover {
    background-color: #f3f4f6;
    box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

.icon-blue {
    color: #3b82f6;
}

.icon-red {
    color: #ef4444;
}

.icon-green {
    color: #10b981;
}

.icon-purple {
    color: #9333ea;
}

.icon-orange {
    color: #f97316;
}

/* Custom styles for the table in the delete all modal */
.delete-all-modal-table {
    width: 100%;
    border-collapse: collapse;
}

.delete-all-modal-table th,
.delete-all-modal-table td {
    padding: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
}

.delete-all-modal-table th:last-child,
.delete-all-modal-table td:last-child {
    text-align: center;
    width: 1%; /* Shrink column for checkbox */
}

/* New style for multiline button label (applied to the button itself now) */
.multiline-label .icon-label {
    line-height: 1.2; /* Tighter line height for two-line text */
    text-align: center;
}

/* The text field and status container now have transparent background and solid borders for contrast against the glassmorphism card */

#delayReason {
/* Makes the background completely transparent */
background-color: transparent;

/* Sets a solid 1-pixel black border */
border: 1px solid black;

/* Ensures the text remains fully opaque (black) */
color: black;

/* Optional: Removes the default focus outline that might interfere */
outline: none;
}

#statusContainer {
/* Makes the background completely transparent */
background-color: transparent;


/* Ensures the text remains fully opaque (black) */
color: black;

/* Optional: Removes the default focus outline that might interfere */
outline: none;

/* To handle the existing inline style and classes from your HTML: */
/* Re-setting the padding, margin-top, and border-radius (if desired) */
margin-top: 1rem;
padding: 0.75rem;
border-radius: 0.5rem;
border: 1px solid black; /* Add border for contrast */
}
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100 p-6">
<div class="max-w-4xl mx-auto p-6 rounded-lg shadow-md form-container">

    <form id="flightForm" class="legacy-grid">

        <div class="form-group">
            <input type="text" id="flightNumber" inputmode="numeric" pattern="[0-9]*" class="form-input" placeholder=" "
                   required value="6E"/>
            <label for="flightNumber" class="form-label">Flight Number</label>
        </div>

        <div class="form-group">
            <input type="text" id="co" inputmode="numeric" pattern="[0-9]*" class="form-input time-input" placeholder=" "
                   maxlength="5" required/>
            <label for="co" class="form-label">CO</label>
        </div>

        <div class="form-group">
            <input type="text" id="ho" inputmode="numeric" pattern="[0-9]*" class="form-input time-input" placeholder=" "
                   maxlength="5" required/>
            <label for="ho" class="form-label">HO</label>
        </div>

        <div class="form-group">
            <input type="text" id="firstBag" inputmode="numeric" pattern="[0-9]*" class="form-input time-input"
                   placeholder=" " maxlength="5" required/>
            <label for="firstBag" class="form-label">First Bag</label>
            <div id="firstBagStatus" class="mt-1 text-xs"></div>
        </div>

        <div class="form-group">
            <input type="text" id="lastBag" inputmode="numeric" pattern="[0-9]*" class="form-input time-input"
                   placeholder=" " maxlength="5" required/>
            <label for="lastBag" class="form-label">Last Bag</label>
            <div id="lastBagStatus" class="mt-1 text-xs"></div>
        </div>

        <div class="form-group">
            <input type="text" id="manager" class="form-input" placeholder=" " required/>
            <label for="manager" class="form-label">Flight Manager</label>
        </div>

        <div class="form-group">
            <input type="text" id="arrivalStaff" class="form-input" placeholder=" " required/>
            <label for="arrivalStaff" class="form-label">Arrival Staff</label>
        </div>

        <div class="form-group">
            <input type="text" id="bbaStaff" class="form-input" placeholder=" " required/>
            <label for="bbaStaff" class="form-label">BBA Staff</label>
        </div>
        
        <div class="col-span-full mt-2 mb-4 text-xs italic text-gray-500 text-center">
            Tip: Double-tap or double-click time fields (CO, HO, First/Last Bag) to automatically enter the current time.
        </div>
        
        <div class="form-group">
            <label for="delayReason" id="delayReasonLabel" class="block text-sm text-gray-600 mb-1">
                Delay Reason
            </label>

            <div id="delayReasonOptions" class="hidden mt-2">

                <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                    <label class="flex items-center space-x-2 p-1 hover:bg-gray-50 rounded">
                        <input type="checkbox" class="delay-reason-checkbox"
                               value="Heavy and bulky bags"/>
                        <span class="text-sm whitespace-nowrap">Heavy and bulky bags</span>
                    </label>
                    <label class="flex items-center space-x-2 p-1 hover:bg-gray-50 rounded">
                        <input type="checkbox" class="delay-reason-checkbox" value="Shortage of helpers"/>
                        <span class="text-sm whitespace-nowrap">Shortage of helpers</span>
                    </label>
                    <label class="flex items-center space-x-2 p-1 hover:bg-gray-50 rounded">
                        <input type="checkbox" class="delay-reason-checkbox" value="Clashing of flights"/>
                        <span class="text-sm whitespace-nowrap">Clashing of flights</span>
                    </label>
                    <label class="flex items-center space-x-2 p-1 hover:bg-gray-50 rounded">
                        <input type="checkbox" class="delay-reason-checkbox" value="Trolleys received late"/>
                        <span class="text-sm whitespace-nowrap">Trolleys received late</span>
                    </label>
                </div>
            </div>

            <textarea id="delayReason" class="w-full p-2 border rounded disabled-field" placeholder="e.g., NA"
                      disabled></textarea>
        </div>
        
    </form>
    <div>
    </div>

    <div id="statusContainer" class="mt-4 p-3 bg-gray-100 rounded-lg"></div>

    <div class="mt-6 grid grid-cols-4 gap-4">
        
        <button onclick="shareViaUniversal()"
                class="icon-button-container-new icon-button-share">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share-2 icon-green"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>
            <span class="text-sm text-green-600 icon-label">Share</span>
        </button>
        
        <button onclick="generateResult('msteams')"
                class="icon-button-container-new icon-button-teams multiline-label">
            <img src="https://img.icons8.com/color/48/microsoft-teams.png" alt="microsoft-teams" width="24" height="24"/>
            <span class="text-sm text-purple-600 icon-label">Share<br>on Teams</span>
        </button>

        <button onclick="copyResult()" id="copyButton" 
                class="icon-button-container-new icon-button-copy relative"> 
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy-plus icon-blue"><line x1="15" x2="15" y1="18" y2="12"/><line x1="12" x2="18" y1="15" y2="15"/><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
            <span class="text-sm text-blue-600 icon-label">Copy</span>
        </button>
        
        <button onclick="showClearConfirmation()"
                class="icon-button-container-new icon-button-clear">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 icon-red"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
            <span class="text-sm text-red-600 icon-label">Clear</span>
        </button>
    </div>
    
    <div class="mt-4 grid grid-cols-4 gap-4">
        
        <button onclick="undoClearForm()" id="undoClearButton" 
                class="icon-button-container-new icon-button-undo col-span-1 relative hidden">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-ccw icon-blue"><path d="M19 14v6"/><path d="M11.643 20.184 19 20v-4"/><path d="M21.737 14.896a10 10 0 1 1-2.92-9.28"/><path d="M12 2v6"/><path d="M4.357 3.816 2 4V8"/></svg>
            <span class="text-sm text-blue-600 icon-label">Undo Clear</span>
        </button>

        <button onclick="saveFlightData()" id="addFlightButtonContainer"
                class="icon-button-container-new icon-button-save col-span-1 relative hidden">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save-all icon-purple"><path d="M12 21h-7a2 2 0 0 1-2-2v-14c0-1.1.9-2 2-2h11l5 5v3"/><path d="M22 17a5 5 0 0 0-5-5h-1"/><path d="M17 22v-6"/><path d="m17 16-2 2 2 2"/><path d="m22 22-2-2-2 2"/><path d="M18 5h-4"/><path d="M8 2h4"/></svg>
            <span class="text-sm text-purple-600 icon-label">Save Flight</span>
        </button>

        <button onclick="showDeleteCurrentFlightConfirmation()" 
                class="icon-button-container-new icon-button-delete-current col-span-1 relative">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 icon-red"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
            <span class="text-sm text-red-600 icon-label">Delete Current</span>
        </button>

        <button onclick="showDeleteAllConfirmation()" 
                class="icon-button-container-new icon-button-delete-all col-span-1 relative">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 icon-red"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
            <span class="text-sm text-red-600 icon-label">Delete Saved</span>
        </button>
    </div>

    <div id="savedFlightsContainer" class="mt-6 border-t pt-4 hidden">
        <h2 class="text-lg font-bold mb-3 text-gray-700">Saved Flights (Tap to Load)</h2>
        <div id="savedFlightsList" class="flex flex-wrap gap-2 mb-4">
            </div>

        <div id="flightActionsContainer" class="grid grid-cols-4 gap-4 hidden">
            <button onclick="copyAllFlightsAsTable()" id="copyAllFlightsTableButton"
                    class="icon-button-container-new icon-button-copy-table col-span-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-check icon-orange"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="m9 14 2 2 4-4"/></svg>
                <span class="text-sm text-orange-600 icon-label">Copy All (Table)</span>
            </button>
            <button onclick="copyAllFlightsAsText()" id="copyAllFlightsTextButton"
                    class="icon-button-container-new icon-button-copy-text col-span-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list icon-orange"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 15h4"/><path d="M8 11h.01"/><path d="M8 15h.01"/></svg>
                <span class="text-sm text-orange-600 icon-label">Copy All (Text)</span>
            </button>
        </div>
    </div>


</div>


<div class="modal-overlay hidden" id="deleteConfirmationModal">
    <div class="modal-content">
        <button class="close-button" onclick="hideClearConfirmation()">&times;</button>
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-triangle text-red-500 mx-auto mb-4"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
        <h2 class="text-xl font-bold mb-4">Confirm Clear</h2>
        <p class="text-gray-700 mb-6">Are you sure you want to clear the main form data? Staff data will be kept. You can **Undo** this action immediately after.</p>
        <div class="flex justify-end gap-3">
            <button onclick="undoClearForm(); hideClearConfirmation();" id="undoClearInModal"
                    class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 text-sm hidden">
                Undo
            </button>
            <button onclick="hideClearConfirmation()"
                    class="bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400 text-sm">
                Cancel
            </button>
            <button onclick="clearConfirmedForm()"
                    class="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 text-sm">
                Yes, Clear
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="clearAfterShareConfirmation">
    <div class="modal-content">
        <button class="close-button" onclick="hideClearAfterShareConfirmation()">&times;</button>
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-check text-green-500 mx-auto mb-4"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="m9 14 2 2 4-4"/></svg>
        <h2 class="text-xl font-bold mb-4">Data Copied/Shared!</h2>
        <p class="text-gray-700 mb-4">Do you want to clear the form now for the next flight?</p>
        
        <label class="flex items-center space-x-2 justify-center mb-6 text-sm text-gray-600">
            <input type="checkbox" id="alwaysClearCheckbox" class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
            <span>Always clear after a successful share/copy</span>
        </label>

        <div class="flex justify-end gap-3">
            <button onclick="hideClearAfterShareConfirmation()"
                    class="bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400 text-sm">
                No, Keep Data
            </button>
            <button onclick="confirmClearAfterShare()"
                    class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 text-sm">
                Yes, Clear
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="teamsAlertModal">
    <div class="modal-content">
        <h2 class="text-xl font-bold mb-4 text-purple-600">Teams Share Notice</h2>
        <p class="text-gray-700 mb-6">
            The **Share on Teams** button uses a deep link which often only works reliably when opening in the **Teams desktop app** or **mobile app**.
            If the data doesn't appear, please use the **Copy** button instead.
        </p>
        <div class="flex justify-center">
            <button onclick="hideTeamsAlertModal()"
                    class="bg-purple-500 text-white py-2 px-4 rounded hover:bg-purple-600 text-sm">
                OK, Proceed to Teams
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="teamsFailModal">
    <div class="modal-content">
        <button class="close-button" onclick="hideTeamsFailModal()">&times;</button>
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-triangle-alert text-red-500 mx-auto mb-4"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
        <h2 class="text-xl font-bold mb-4 text-red-600">Teams Share Failed</h2>
        <p class="text-gray-700 mb-6" id="teamsFailMessage">Sharing failed, this button may only work in workprofile web browser.</p>
        <div class="flex justify-center">
            <button onclick="hideTeamsFailModal()"
                    class="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 text-sm">
                Close
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="deleteCurrentFlightConfirmationModal">
    <div class="modal-content">
        <button class="close-button" onclick="hideDeleteCurrentFlightConfirmation()">&times;</button>
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2 text-red-500 mx-auto mb-4"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
        <h2 class="text-xl font-bold mb-4 text-red-600">Delete Flight</h2>
        <p class="text-gray-700 mb-6" id="deleteCurrentFlightModalText"></p>
        <div class="flex justify-end gap-3">
            <button onclick="hideDeleteCurrentFlightConfirmation()"
                    class="bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400 text-sm">
                Cancel
            </button>
            <button onclick="confirmDeleteCurrentFlight()"
                    class="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 text-sm">
                Confirm Delete
            </button>
        </div>
    </div>
</div>

<div class="modal-overlay hidden" id="deleteAllConfirmationModal">
    <div class="modal-content !w-[450px]">
        <button class="close-button" onclick="hideDeleteAllConfirmation()">&times;</button>
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-checks text-red-500 mx-auto mb-4"><path d="m3 21 3.2-3.2"/><path d="M8 15h12"/><path d="m19 18 2-2 4-4"/><path d="M3 3 6.2 6.2"/><path d="M8 9h12"/><path d="m19 12 2-2 4-4"/><path d="M3 12 6.2 15.2"/><path d="M12 21h4"/></svg>
        <h2 class="text-xl font-bold mb-4 text-center">Delete Saved Flights</h2>
        
        <div class="max-h-60 overflow-y-auto">
            <table class="delete-all-modal-table">
                <thead>
                    <tr class="bg-gray-50">
                        <th>Flight Number</th>
                        <th>
                            <label class="flex items-center justify-center cursor-pointer">
                                <input type="checkbox" id="selectAllFlights" onclick="toggleSelectAll(this)">
                            </label>
                        </th>
                    </tr>
                </thead>
                <tbody id="deleteFlightsTableBody">
                    </tbody>
            </table>
        </div>

        <div class="flex justify-end gap-3 mt-6">
            <button onclick="hideDeleteAllConfirmation()"
                    class="bg-gray-300 text-gray-700 py-2 px-4 rounded hover:bg-gray-400 text-sm">
                Close
            </button>
            <button id="confirmDeleteSelectedBtn" onclick="confirmDeleteSelected()" disabled
                    class="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600 text-sm opacity-50 cursor-not-allowed">
                Delete Selected
            </button>
        </div>
    </div>
</div>

<script>
const EXPIRY_TIME_MS = 6 * 60 * 60 * 1000; // 6 hours in milliseconds
let flightToDelete = null;

// [CORRECTED] Global variable to store the last cleared form data
let lastClearedFormData = null;

// New constants and functions for the "Always Clear" feature
const ALWAYS_CLEAR_KEY = "alwaysClearForm";
// NEW: Constant for the one-time Teams alert
const SHOW_TEAMS_ALERT_KEY = "showTeamsAlert";

function getAlwaysClearPreference() {
    return localStorage.getItem(ALWAYS_CLEAR_KEY) === "true";
}

function setAlwaysClearPreference(isAlwaysClear) {
    localStorage.setItem(ALWAYS_CLEAR_KEY, isAlwaysClear ? "true" : "false");
}

function showClearAfterShareConfirmation() {
    document.getElementById("clearAfterShareConfirmation").style.display = "flex";
    document.getElementById("alwaysClearCheckbox").checked = getAlwaysClearPreference();
}

function hideClearAfterShareConfirmation() {
    document.getElementById("clearAfterShareConfirmation").style.display = "none";
}

function confirmClearAfterShare() {
    if (document.getElementById("alwaysClearCheckbox").checked) {
        setAlwaysClearPreference(true);
    }
    clearConfirmedForm();
    hideClearAfterShareConfirmation();
}

// [CORRECTED] Helper function to get the current form data
function getCurrentFormData() {
    const form = document.getElementById('flightForm');
    const formData = {};
    
    // Get all form elements with IDs
    const elements = form.querySelectorAll('input, select, textarea');
    elements.forEach(element => {
        if (element.id && element.type !== 'checkbox') {
            // Save value for all text/time/textarea inputs
            formData[element.id] = element.value;
        }
    });

    // Save checkbox states separately
    formData.delayReasonCheckboxes = Array.from(form.querySelectorAll('.delay-reason-checkbox')).map(cb => ({
        value: cb.value,
        checked: cb.checked
    }));

    return formData;
}

// [NEW] Function to hide the undo button and clear the stored data
function hideUndoButton() {
    const undoButton = document.getElementById('undoClearButton');
    if (undoButton) {
        undoButton.classList.add('hidden');
    }
    lastClearedFormData = null;
}

// [CORRECTED] Function to restore the form state (called by the Undo button)
function undoClearForm() {
    if (lastClearedFormData) {
        // 1. Restore the data (non-checkbox fields)
        for (const id in lastClearedFormData) {
            if (id !== 'delayReasonCheckboxes') {
                const element = document.getElementById(id);
                if (element) {
                    element.value = lastClearedFormData[id];
                }
            }
        }
        
        // 2. Restore checkbox states
        if (lastClearedFormData.delayReasonCheckboxes) {
             lastClearedFormData.delayReasonCheckboxes.forEach(savedCb => {
                document.querySelectorAll('.delay-reason-checkbox').forEach(currentCb => {
                    if (currentCb.value === savedCb.value) {
                        currentCb.checked = savedCb.checked;
                    }
                });
             });
        }

        // 3. Hide the undo button and clear the stored data
        hideUndoButton();
        
        // 4. Trigger UI update after restoring and save data to local storage
        // Dispatch event on CO to trigger HO recalculation and updateAllUI
        const coInput = document.getElementById("co");
        if (coInput) {
            coInput.dispatchEvent(new Event('input'));
        }
        
        // Ensure data that should persist (staff) and the main form data are re-saved
        saveNonFlightData();
        saveStaffData(); 
        
        // Re-run setupFloatingLabels to ensure labels are correctly positioned for restored values
        setupFloatingLabels();
    }
}


// NEW: Function to handle the successful sharing/copying action (Removed form validity check)
function handleSuccessfulShare() {
    // The previous form validity check is removed to allow sharing/coping with empty fields
    if (getAlwaysClearPreference()) {
        // [MODIFIED] Call clearConfirmedForm() here instead of clearMainForm() 
        // to ensure it saves the state before clearing, in case the user wants to undo the automatic clear.
        clearConfirmedForm(true); // true means skip confirmation modal
    } else {
        showClearAfterShareConfirmation();
    }
}

// The checkFormValidity is kept for internal use like preventing '6E' from being saved,
// but it is no longer used to block button actions.
function checkFormValidity() {
    const flightNumber = document.getElementById("flightNumber").value.trim();
    const co = document.getElementById("co").value.trim();
    const ho = document.getElementById("ho").value.trim();
    const firstBag = document.getElementById("firstBag").value.trim();
    const lastBag = document.getElementById("lastBag").value.trim();
    const manager = document.getElementById("manager").value.trim();
    const arrivalStaff = document.getElementById("arrivalStaff").value.trim();
    const bbaStaff = document.getElementById("bbaStaff").value.trim();

    // Check if any of the main required fields are empty
    return !!(flightNumber && flightNumber !== "6E" && co && ho && firstBag && lastBag && manager && arrivalStaff && bbaStaff);
}

// Function to set the 'hideTeamsAlert' flag
function setHideTeamsAlert() {
    localStorage.setItem("hideTeamsAlert", "true");
}

function showTeamsFailModal() {
    document.getElementById("teamsFailModal").style.display = "flex";
    // Update the message in the modal as requested
    document.getElementById("teamsFailMessage").innerText = "Sharing failed, this button may only work in workprofile web browser.";
}

function hideTeamsFailModal() {
    document.getElementById("teamsFailModal").style.display = "none";
}

// MODIFIED: Function to show the first-time Teams alert (Removed setTimeout)
function showTeamsAlertModal() {
    document.getElementById("teamsAlertModal").style.display = "flex";
    // Removed setTimeout - modal now waits for user to click 'OK'.
}

// MODIFIED: Function to hide the first-time Teams alert (Now calls openTeamsChat)
function hideTeamsAlertModal() {
    document.getElementById("teamsAlertModal").style.display = "none";
    localStorage.setItem(SHOW_TEAMS_ALERT_KEY, "false"); // Set preference to not show again
    openTeamsChat(); // Proceed to open Teams after the user clicks 'OK'
}

// --- Data Saving and Loading Functions ---
// MODIFIED: saveNonFlightData no longer saves arrivalStaff or bbaStaff, 
// as they are handled by saveStaffData to ensure they persist across a clearMainForm call.
function saveNonFlightData() {
    const flightNumber = document.getElementById("flightNumber").value;
    const co = document.getElementById("co").value;
    const ho = document.getElementById("ho").value;
    const firstBag = document.getElementById("firstBag").value;
    const lastBag = document.getElementById("lastBag").value;
    const manager = document.getElementById("manager").value;
    const delayReason = document.getElementById("delayReason").value;

    // Create an object to save all flight-related form values
    const currentFormData = {
        flightNumber: flightNumber,
        co: co,
        ho: ho,
        firstBag: firstBag,
        lastBag: lastBag,
        manager: manager,
        delayReason: delayReason,
        // Removed arrivalStaff and bbaStaff
    };
    // Save the current form data to a single key in localStorage
    localStorage.setItem("currentFormData", JSON.stringify(currentFormData));
}

// New function to load data from localStorage on page load
function loadCurrentFormData() {
    const savedData = localStorage.getItem("currentFormData");
    if (savedData) {
        const data = JSON.parse(savedData);
        document.getElementById("flightNumber").value = data.flightNumber || "6E";
        document.getElementById("co").value = data.co || "";
        document.getElementById("ho").value = data.ho || "";
        document.getElementById("firstBag").value = data.firstBag || "";
        document.getElementById("lastBag").value = data.lastBag || "";
        document.getElementById("manager").value = data.manager || "";
        document.getElementById("delayReason").value = data.delayReason || "";
        // arrivalStaff and bbaStaff are now loaded via loadAllData -> loadStaffData
    }
}

// Function to parse time
function parseTime(time) {
    const [hours, minutes] = time.split(":").map(Number);
    return new Date(1970, 0, 1, hours, minutes);
}

// Function to format time into HH:MM
function formatTime(date) {
    const hours = String(date.getHours()).padStart(2, "0");
    const minutes = String(date.getMinutes()).padStart(2, "0");
    return `${hours}:${minutes}`;
}

// Function to save arrival and BBA staff data (persists across form clear)
function saveStaffData() {
    const arrivalStaff = document.getElementById("arrivalStaff").value;
    const bbaStaff = document.getElementById("bbaStaff").value;
    localStorage.setItem("arrivalStaff", arrivalStaff);
    localStorage.setItem("bbaStaff", bbaStaff);
}

// NEW: Function to load staff data
function loadStaffData() {
    const savedArrivalStaff = localStorage.getItem("arrivalStaff");
    const savedBbaStaff = localStorage.getItem("bbaStaff");

    if (savedArrivalStaff) {
        document.getElementById("arrivalStaff").value = savedArrivalStaff;
    }
    if (savedBbaStaff) {
        document.getElementById("bbaStaff").value = savedBbaStaff;
    }
}

function saveFlightData() {
    const flightNumber = document.getElementById("flightNumber").value.trim();
    if (!flightNumber || flightNumber === "6E") {
        // Prevents saving the default "6E" as a new flight
        return;
    }
    const allFlightsData =
        JSON.parse(localStorage.getItem("allFlightsData")) || {};
    allFlightsData[flightNumber] = {
        co: document.getElementById("co").value,
        ho: document.getElementById("ho").value,
        firstBag: document.getElementById("firstBag").value,
        lastBag: document.getElementById("lastBag").value,
        manager: document.getElementById("manager").value,
        delayReason: document.getElementById("delayReason").value || "",
        timestamp: Date.now(),
    };
    localStorage.setItem("allFlightsData", JSON.stringify(allFlightsData));
}

function loadSavedFlight(flightNumber) {
    saveFlightData(); // First, save the current flight data as a permanent entry.
    const allFlightsData =
        JSON.parse(localStorage.getItem("allFlightsData")) || {};
    const flightData = allFlightsData[flightNumber];
    if (flightData) {
        document.getElementById("flightNumber").value = flightNumber;
        document.getElementById("co").value = flightData.co;
        document.getElementById("ho").value = flightData.ho;
        document.getElementById("firstBag").value = flightData.firstBag;
        document.getElementById("lastBag").value = flightData.lastBag;
        document.getElementById("manager").value = flightData.manager;
        document.getElementById("delayReason").value = flightData.delayReason || "";
        
        // Also clear delay checkboxes when loading a flight, as the text area is set.
        document.querySelectorAll(".delay-reason-checkbox").forEach((checkbox) => {
            checkbox.checked = false;
        });

        // Staff data is intentionally NOT overwritten when loading a flight
        updateAllUI();
        
        // [NEW] Hide the undo button when loading a saved flight
        hideUndoButton();
        setupFloatingLabels(); // Ensure labels are correct
    }
}

function loadAllData() {
    const allFlightsData =
        JSON.parse(localStorage.getItem("allFlightsData")) || {};
    // Cleanup expired flight data
    const now = Date.now();
    const cleanedFlightsData = {};
    for (const flight in allFlightsData) {
        if (now - allFlightsData[flight].timestamp < EXPIRY_TIME_MS) {
            cleanedFlightsData[flight] = allFlightsData[flight];
        }
    }
    localStorage.setItem("allFlightsData", JSON.stringify(cleanedFlightsData));
    
    // Load staff data (persists across clears)
    loadStaffData();

    updateSavedFlightsList();
    loadCurrentFormData(); // Load the flight-related form state on every page load
}

// MODIFIED: updateSavedFlightsList to remove individual delete button and manage new buttons
function updateSavedFlightsList() {
    const savedFlightsList = document.getElementById("savedFlightsList");
    const savedFlightsContainer = document.getElementById("savedFlightsContainer");
    const flightActionsContainer = document.getElementById("flightActionsContainer");
    savedFlightsList.innerHTML = ""; // Clear previous buttons
    const allFlightsData =
        JSON.parse(localStorage.getItem("allFlightsData")) || {};
    const flightNumbers = Object.keys(allFlightsData).reverse();

    if (flightNumbers.length === 0) {
        savedFlightsContainer.style.display = "none";
        flightActionsContainer.classList.add("hidden");
    } else {
        savedFlightsContainer.style.display = "block";
        flightActionsContainer.classList.remove("hidden");
        flightNumbers.forEach((flightNumber) => {
            const button = document.createElement("button");
            button.textContent = flightNumber;
            button.className = "saved-flight-item";
            button.onclick = () => loadSavedFlight(flightNumber);

            // Removed individual delete span/button

            savedFlightsList.appendChild(button);
        });
    }
}

// --- NEW: Function to handle double-click time entry ---
function handleTimeDblClick(event) {
    const inputElement = event.target;
    const now = new Date();
    const currentTime = formatTime(now);
    
    // Set the current time in the input field
    inputElement.value = currentTime;
    
    // If the input is 'HO' (Hand Over) and 'CO' is empty, we only set the time.
    // If the input is 'CO' (Clear Out), we set the time and auto-calculate 'HO'.
    if (inputElement.id === "co") {
        // Trigger the 'input' event on 'co' to run the auto-calculation of 'ho'
        inputElement.dispatchEvent(new Event('input'));
    } else if (inputElement.id === "ho") {
        // Manually trigger the input event to run validation/formatting
        inputElement.dispatchEvent(new Event('input'));
    } else {
        // For First Bag and Last Bag, trigger input event for validation/formatting
        inputElement.dispatchEvent(new Event('input'));
    }

    // Also explicitly call saveNonFlightData since we've changed the value
    saveNonFlightData();
}
// --- END NEW FUNCTION ---

// --- Event Listeners for Saving Data and UI changes ---
document.getElementById("flightNumber").addEventListener("input", (e) => {
    const addFlightButtonContainer = document.getElementById(
        "addFlightButtonContainer"
    );
    if (e.target.value.trim().length > 2 && e.target.value.trim() !== "6E") {
        // Prevents showing "Add Flight" for default value
        addFlightButtonContainer.classList.remove("hidden");
    } else {
        addFlightButtonContainer.classList.add("hidden");
    }
    // [NEW] Hide undo button on a new keypress in flight number field
    hideUndoButton();
});

// MODIFIED: Add event listeners to all form fields, including dblclick for CO and HO.
document.querySelectorAll(".form-input, .time-input, .delay-reason-checkbox").forEach((input) => {
    if (input.id === "arrivalStaff" || input.id === "bbaStaff") {
        input.addEventListener("input", saveStaffData);
    } else {
        input.addEventListener("input", saveNonFlightData);
        // [NEW] Hide undo button on a new keypress in any main field
        input.addEventListener("input", hideUndoButton);
    }
    
    // MODIFIED: Add double-click event listener for CO, HO, First Bag, and Last Bag
    if (input.id === "co" || input.id === "ho" || input.id === "firstBag" || input.id === "lastBag") {
        input.addEventListener("dblclick", handleTimeDblClick);
    }
});

// Auto-format time input with colon and validate
document.querySelectorAll(".time-input").forEach((input) => {
    input.addEventListener("input", () => {
        let value = input.value.replace(/[^0-9:]/g, "");
        if (value.length > 2 && !value.includes(":")) {
            value = value.slice(0, 2) + ":" + value.slice(2);
        }
        if (value.length > 5) {
            value = value.slice(0, 5);
        }
        input.value = value;
        const [hours, minutes] = value.split(":").map(Number);
        const isInvalid =
            hours > 23 ||
            isNaN(hours) ||
            minutes > 59 ||
            isNaN(minutes) ||
            (value.includes(":") && minutes === undefined);
        if (isInvalid) {
            input.classList.add("border-red-500");
        } else {
            input.classList.remove("border-red-500");
        }
        updateAllUI();
    });
});

// Function to auto-calculate HO time based on CO time
document.getElementById("co").addEventListener("input", (e) => {
    const coTime = e.target.value;
    const hoInput = document.getElementById("ho");
    if (coTime.length === 5 && !e.target.classList.contains("border-red-500")) {
        const [hours, minutes] = coTime.split(":").map(Number);
        let hoDate = new Date();
        hoDate.setHours(hours, minutes + 2, 0, 0);
        hoInput.value = formatTime(hoDate);
    }
    // Note: The 'input' event listener on 'ho' will handle saving/UI update for 'ho' after this change.
});

function formatDate(date) {
    const day = String(date.getDate()).padStart(2, "0");
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const year = String(date.getFullYear()).slice(-2);
    return `${day}/${month}/${year}`;
}

function calculateTimeDifference(startTime, endTime) {
    if (!startTime || !endTime) return null;
    const start = parseTime(startTime);
    const end = parseTime(endTime);
    if (end < start) end.setDate(end.getDate() + 1);
    const timeDifference = (end - start) / 60000;
    return Math.round(timeDifference);
}

function getResultText() {
    const flightNumber = document.getElementById("flightNumber").value;
    const co = document.getElementById("co").value;
    const ho = document.getElementById("ho").value;
    const firstBag = document.getElementById("firstBag").value;
    const lastBag = document.getElementById("lastBag").value;
    const manager = document.getElementById("manager").value;
    const arrivalStaff = document.getElementById("arrivalStaff").value;
    const bbaStaff = document.getElementById("bbaStaff").value;
    const delayReason = document.getElementById("delayReason").value || "NA";

    const today = new Date();
    const formattedDate = formatDate(today);

    const firstBagTime = calculateTimeDifference(co, firstBag);
    const totalTime = calculateTimeDifference(co, lastBag);

    const fbAchieved =
        firstBagTime !== null && firstBagTime <= 10 ? "Achieved" : "Not Achieved";
    const lbAchieved =
        totalTime !== null && totalTime <= 20 ? "Achieved" : "Not Achieved";
    const result = `
BBA FB-LB Status
${formattedDate}

Flight Number: ${flightNumber}
CO: ${co}
HO: ${ho}
First Bag: ${firstBag} (${fbAchieved})
Last Bag: ${lastBag} (${lbAchieved})
Total Time Taken: ${totalTime !== null ? totalTime : "NA"} minutes
Flight Manager: ${manager}
Arrival Staff: ${arrivalStaff}
BBA Staff: ${bbaStaff}

Delay Reason: ${delayReason}`.trim();
    return result;
}

// --- MODIFIED FUNCTION: Generate HTML Table (Title and Date in separate Header cells) ---
function generateTableHTML() {
    const flightNumber = document.getElementById("flightNumber").value;
    const co = document.getElementById("co").value;
    const ho = document.getElementById("ho").value;
    const firstBag = document.getElementById("firstBag").value;
    const lastBag = document.getElementById("lastBag").value;
    const manager = document.getElementById("manager").value;
    const arrivalStaff = document.getElementById("arrivalStaff").value;
    const bbaStaff = document.getElementById("bbaStaff").value;
    const delayReason = document.getElementById("delayReason").value || "NA";

    const today = new Date();
    const formattedDate = formatDate(today);

    const firstBagTime = calculateTimeDifference(co, firstBag);
    const totalTime = calculateTimeDifference(co, lastBag);

    const fbAchieved =
        firstBagTime !== null && firstBagTime <= 10 ? "Achieved" : "Not Achieved";
    const lbAchieved =
        totalTime !== null && totalTime <= 20 ? "Achieved" : "Not Achieved";

    // HTML with inline styles for basic compatibility in email/Teams
    const style = `border-collapse: collapse; width: 100%; font-family: sans-serif; font-size: 14px;`;
    // Header style for the title and date rows
    const thStyle = `border: 1px solid #ccc; padding: 8px; text-align: left; background-color: #f2f2f2; font-weight: bold;`;
    // Data cell style
    const tdStyle = `border: 1px solid #ccc; padding: 8px; text-align: left;`;

    // Helper function to create a status span
    const statusSpan = (value, achieved) => {
        const color = achieved === "Achieved" ? "green" : (achieved === "Not Achieved" ? "red" : "gray");
        return `<span style="font-weight: bold;">${value}</span> <span style="color: ${color};">(${achieved})</span>`;
    };

    // Function to create a basic table row
    const createRow = (field, value) => {
        const displayValue = value || "&nbsp;"; // Use a 40% width on the field column to clearly separate key from value
        return `<tr><td style="${tdStyle} width: 40%;">${field}</td><td style="${tdStyle}">${displayValue}</td></tr>`;
    }

    // Function to create the status row (First Bag, Last Bag)
    const createStatusRow = (field, timeValue, achievedStatus) => {
        const displayTimeValue = timeValue || 'NA';
        const displayStatus = timeValue !== null ? statusSpan(displayTimeValue, achievedStatus) : 'NA';
        return `<tr><td style="${tdStyle} width: 40%;">${field}</td><td style="${tdStyle}">${displayStatus}</td></tr>`;
    }

    // MODIFIED STRUCTURE: Title in first <th>, Date in second <th>.
    const html = `
    <table style="${style}">
        <thead>
            <tr>
                <th style="${thStyle} width: 40%;">BBA FB-LB Status</th>
                <th style="${thStyle} width: 60%;">(Date: ${formattedDate})</th>
            </tr>
        </thead>
        <tbody>
            <tr><td style="${tdStyle}" colspan="2">&nbsp;</td></tr>
            ${createRow('Flight Number', flightNumber)}
            ${createRow('CO', co)}
            ${createRow('HO', ho)}
            ${createStatusRow('First Bag', firstBag, fbAchieved)}
            ${createStatusRow('Last Bag', lastBag, lbAchieved)}
            ${createRow('Total Time Taken', (totalTime !== null ? totalTime + ' minutes' : 'NA'))}
            ${createRow('Flight Manager', manager)}
            ${createRow('Arrival Staff', arrivalStaff)}
            ${createRow('BBA Staff', bbaStaff)}
            ${createRow('Delay Reason', delayReason)}
        </tbody>
    </table>
    `.trim();
    return html;
}

// --- MODIFIED FUNCTION: Copy HTML Only to Clipboard (No fallback) ---
async function copyHtmlToClipboard(htmlString) {
    if (!document.execCommand) {
        console.warn("document.execCommand is required for rich-text clipboard copy and is not available in this environment.");
        return false;
    }

    try {
        // Create a temporary element to hold the content
        const tempElement = document.createElement('div');
        tempElement.innerHTML = htmlString;
        tempElement.style.position = 'absolute';
        tempElement.style.left = '-9999px'; // Hide it off-screen
        document.body.appendChild(tempElement);

        const range = document.createRange();
        range.selectNodeContents(tempElement);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);

        // Use the deprecated execCommand('copy') which often correctly copies both HTML and plain text (rich text)
        const success = document.execCommand('copy');

        selection.removeAllRanges();
        document.body.removeChild(tempElement);

        return success; // Returns true or false based on execCommand('copy') success

    } catch (err) {
        console.error("Failed to copy HTML using execCommand:", err);
        return false; // Return false on failure
        // Plain text fallback removed as per user request
    }
}

// --- MODIFIED FUNCTION: Action for "Share as Table" button ---
async function shareAsTableViaUniversal() {
    const htmlTable = generateTableHTML();
    // Only attempt rich-text copy
    const success = await copyHtmlToClipboard(htmlTable);

    if (success) {
        // Show existing copy dialog (feedback + clear confirmation)
        showCopyFeedback("shareAsTableButton");
        handleSuccessfulShare();
    } else {
        // Show failure message if HTML copy failed
        alert("Failed to copy data. Your browser may not support rich text clipboard operations.");
    }
}

// New function to generate a single string from all saved flights
function getAllFlightsText() {
    const allFlightsData = JSON.parse(localStorage.getItem("allFlightsData")) || {};
    const flightNumbers = Object.keys(allFlightsData).reverse();
    const allData = flightNumbers.map(flightNumber => {
        const data = allFlightsData[flightNumber];
        const firstBagTime = calculateTimeDifference(data.co, data.firstBag);
        const totalTime = calculateTimeDifference(data.co, data.lastBag);
        const fbAchieved =
            firstBagTime !== null && firstBagTime <= 10 ? "Achieved" : "Not Achieved";
        const lbAchieved =
            totalTime !== null && totalTime <= 20 ? "Achieved" : "Not Achieved";
        const delayReason = data.delayReason || "NA";

        return `
---
Flight: ${flightNumber}
CO: ${data.co}
HO: ${data.ho}
First Bag: ${data.firstBag} (${fbAchieved})
Last Bag: ${data.lastBag} (${lbAchieved})
Total Time Taken: ${totalTime !== null ? totalTime : "NA"} minutes
Manager: ${data.manager}
Delay Reason: ${delayReason}
        `.trim();
    }).join('\n');

    if (allData.length === 0) {
        return "No saved flight data available.";
    }

    return `Saved Flight Data\n${formatDate(new Date())}\n\n${allData}\n---`.trim();
}

// New function to generate an HTML table from all saved flights
function getAllFlightsTableHTML() {
    const allFlightsData = JSON.parse(localStorage.getItem("allFlightsData")) || {};
    const flightNumbers = Object.keys(allFlightsData).reverse();
    
    if (flightNumbers.length === 0) {
        return `<div>No saved flight data available.</div>`;
    }

    const formattedDate = formatDate(new Date());

    const style = `border-collapse: collapse; width: 100%; font-family: sans-serif; font-size: 14px;`;
    const thStyle = `border: 1px solid #ccc; padding: 8px; text-align: left; background-color: #f2f2f2; font-weight: bold;`;
    const tdStyle = `border: 1px solid #ccc; padding: 8px; text-align: left;`;
    
    const statusSpan = (value, achieved) => {
        const color = achieved === "Achieved" ? "green" : (achieved === "Not Achieved" ? "red" : "gray");
        return `<span style="font-weight: bold;">${value}</span> <span style="color: ${color};">(${achieved})</span>`;
    };

    const headerRow = `<tr>
        <th style="${thStyle}">Flight No.</th>
        <th style="${thStyle}">CO</th>
        <th style="${thStyle}">HO</th>
        <th style="${thStyle}">First Bag</th>
        <th style="${thStyle}">Last Bag</th>
        <th style="${thStyle}">Total Time (min)</th>
        <th style="${thStyle}">Manager</th>
        <th style="${thStyle}">Delay Reason</th>
    </tr>`;

    const bodyRows = flightNumbers.map(flightNumber => {
        const data = allFlightsData[flightNumber];
        const firstBagTime = calculateTimeDifference(data.co, data.firstBag);
        const totalTime = calculateTimeDifference(data.co, data.lastBag);
        const fbAchieved =
            firstBagTime !== null && firstBagTime <= 10 ? "Achieved" : "Not Achieved";
        const lbAchieved =
            totalTime !== null && totalTime <= 20 ? "Achieved" : "Not Achieved";
        const delayReason = data.delayReason || "NA";

        return `<tr>
            <td style="${tdStyle}">${flightNumber}</td>
            <td style="${tdStyle}">${data.co}</td>
            <td style="${tdStyle}">${data.ho}</td>
            <td style="${tdStyle}">${data.firstBag} ${firstBagTime !== null ? `(${fbAchieved})` : ''}</td>
            <td style="${tdStyle}">${data.lastBag} ${totalTime !== null ? `(${lbAchieved})` : ''}</td>
            <td style="${tdStyle}">${totalTime !== null ? totalTime : 'NA'}</td>
            <td style="${tdStyle}">${data.manager}</td>
            <td style="${tdStyle}">${delayReason}</td>
        </tr>`;
    }).join('');


    // MODIFIED STRUCTURE: Title in first <th>, Date in second <th>.
    const html = `
    <table style="${style}">
        <thead>
            <tr>
                <th style="${thStyle}; background-color: #e5e7eb;" colspan="8">All Saved Flight Data (Date: ${formattedDate})</th>
            </tr>
            ${headerRow}
        </thead>
        <tbody>
            ${bodyRows}
        </tbody>
    </table>
    `.trim();
    return html;
}


// --- Function to generate the result and share via the Universal Share API ---
function shareViaUniversal() {
    // Form is not checked for validity as the user may want to share partial data
    
    const resultText = getResultText();
    
    if (navigator.share) {
        navigator.share({
            title: "BBA FB-LB Status",
            text: resultText,
        })
        .then(() => {
            console.log('Successful share');
            // MODIFIED: Use handleSuccessfulShare()
            handleSuccessfulShare();
        })
        .catch((error) => console.log('Error sharing', error));
    } else {
        // Fallback for browsers that do not support the Web Share API
        alert("Web Share API is not supported in this browser. Please use the Copy button instead.");
    }
}

// --- Function to generate result and share via MS Teams deep link ---
function generateResult(target) {
    const resultText = getResultText();

    if (target === "msteams") {
        // Check if the user has been shown the initial alert
        const teamsAlertShown = localStorage.getItem(SHOW_TEAMS_ALERT_KEY);

        if (teamsAlertShown !== "false") {
            // Show the modal if it's the first time or if the flag is not set
            showTeamsAlertModal();
            // openTeamsChat() is now called from hideTeamsAlertModal() after user clicks OK
        } else {
            openTeamsChat(resultText);
        }
    }
}

function openTeamsChat(text) {
    if (!text) {
        text = getResultText();
    }

    const encodedText = encodeURIComponent(text);
    // The deep link to start a chat with the bot/user and pre-fill the message
    // NOTE: Teams deep links are notoriously finicky and often only work correctly in the Teams desktop/mobile app or a specific work profile browser environment.
    const teamsDeepLink = `https://teams.microsoft.com/l/chat/0/0?users=&message=${encodedText}`;

    try {
        // Attempt to open the link
        window.location.href = teamsDeepLink;
        
        // Because window.location.href is synchronous, there's no reliable way to check
        // if Teams successfully opened *before* the user leaves the app to confirm.
        // We use a small delay and a prompt to check for successful opening.
        setTimeout(() => {
            // If the user is still on the page, ask if Teams opened
            if (document.visibilityState === 'visible') {
                // This is still unreliable, so let's simplify and just call handleSuccessfulShare
                // to assume success and prompt for clearing the form.
                // If the user clicks 'Share on Teams', we assume they want to clear it if alwaysClear is set.
                handleSuccessfulShare();
            }
        }, 1000); // Wait 1 second before proceeding to clear/prompt
    } catch (error) {
        // This error handler is for browser-level issues, not deep-link failure
        console.error("Error opening Teams deep link:", error);
        showTeamsFailModal(); // Show the failure modal
    }
}


// --- Function to copy the result text to the clipboard ---
function copyResult() {
    // Form is not checked for validity as the user may want to copy partial data
    
    const resultText = getResultText();
    
    // Use modern clipboard API if available
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(resultText)
            .then(() => {
                // MODIFIED: Use handleSuccessfulShare()
                showCopyFeedback("copyButton");
                handleSuccessfulShare();
            })
            .catch(err => {
                console.error('Could not copy text: ', err);
                alert("Copy failed. Your browser may not support the modern clipboard API. Please try manually selecting and copying the text from the status box.");
            });
    } else {
        // Fallback for older browsers (less reliable, especially for success feedback)
        const textArea = document.createElement("textarea");
        textArea.value = resultText;
        textArea.style.position = "fixed"; // Avoid scrolling to bottom
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                // MODIFIED: Use handleSuccessfulShare()
                showCopyFeedback("copyButton");
                handleSuccessfulShare();
            } else {
                alert("Copy failed with execCommand.");
            }
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
            alert("Copy failed. Please try manually selecting and copying the text from the status box.");
        }
        document.body.removeChild(textArea);
    }
}

// New: Function to copy all saved flights in table format
async function copyAllFlightsAsTable() {
    const htmlTable = getAllFlightsTableHTML();
    const success = await copyHtmlToClipboard(htmlTable);

    if (success) {
        showCopyFeedback("copyAllFlightsTableButton");
    } else {
        alert("Failed to copy data. Your browser may not support rich text clipboard operations.");
    }
}


// New: Function to copy all saved flights as plain text
function copyAllFlightsAsText() {
    const resultText = getAllFlightsText();
    
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(resultText)
            .then(() => {
                showCopyFeedback("copyAllFlightsTextButton");
            })
            .catch(err => {
                console.error('Could not copy text: ', err);
                alert("Copy failed. Please try manually selecting and copying the text.");
            });
    } else {
        // Fallback
        const textArea = document.createElement("textarea");
        textArea.value = resultText;
        textArea.style.position = "fixed"; 
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            showCopyFeedback("copyAllFlightsTextButton");
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
            alert("Copy failed. Please try manually selecting and copying the text.");
        }
        document.body.removeChild(textArea);
    }
}


// --- Feedback Functions ---
function showCopyFeedback(buttonId) {
    const button = document.getElementById(buttonId);
    // Find the icon (the first SVG or IMG element)
    const icon = button.querySelector('svg, img'); 
    
    // Find the original color class to restore later
    let originalIconClass = Array.from(icon.classList).find(cls => cls.startsWith('icon-'));

    // Save original icon for restoration
    const originalIconHTML = icon.outerHTML;
    
    // Change icon to a checkmark (using lucide icon) and color to green
    const checkmarkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check icon-green"><path d="M20 6 9 17l-5-5"/></svg>`;
    icon.outerHTML = checkmarkIcon;

    // Change label text
    const label = button.querySelector('.icon-label');
    let originalLabelHTML = label.innerHTML;
    let originalLabelColor = Array.from(label.classList).find(cls => cls.startsWith('text-'));
    
    label.innerHTML = "Copied!";
    label.classList.remove(originalLabelColor);
    label.classList.add('text-green-600');

    setTimeout(() => {
        // Restore original icon and label
        const currentIcon = button.querySelector('svg, img');
        currentIcon.outerHTML = originalIconHTML; // Restores the SVG or IMG and its classes/attributes

        const currentLabel = button.querySelector('.icon-label');
        currentLabel.innerHTML = originalLabelHTML;
        currentLabel.classList.remove('text-green-600');
        currentLabel.classList.add(originalLabelColor);

    }, 2000);
}

// --- Form Clearing and Deletion Functions ---

function showClearConfirmation() {
    // [NEW] Save current form state before showing confirmation
    // This ensures the undo functionality works even if the user cancels the clear and then manually clears later.
    lastClearedFormData = getCurrentFormData();
    
    // Show the main confirmation modal
    document.getElementById("deleteConfirmationModal").style.display = "flex";
    
    // [NEW] Show the undo button in the modal
    const undoInModal = document.getElementById('undoClearInModal');
    if (undoInModal) {
        undoInModal.classList.remove('hidden');
    }
}

function hideClearConfirmation() {
    document.getElementById("deleteConfirmationModal").style.display = "none";
}

function clearConfirmedForm(skipSave = false) {
    // [MODIFIED] If this is not an *automatic* clear after a share, 
    // we save the current state for undo. If it is automatic, the state
    // was already saved by handleSuccessfulShare.
    if (!skipSave) {
        lastClearedFormData = getCurrentFormData();
    }
    
    // Clear all non-staff input fields
    document.getElementById("flightNumber").value = "6E";
    document.getElementById("co").value = "";
    document.getElementById("ho").value = "";
    document.getElementById("firstBag").value = "";
    document.getElementById("lastBag").value = "";
    document.getElementById("manager").value = "";
    document.getElementById("delayReason").value = "";
    
    // Clear all checkboxes
    document.querySelectorAll(".delay-reason-checkbox").forEach((checkbox) => {
        checkbox.checked = false;
    });

    // Save the partially cleared state to localStorage
    saveNonFlightData();
    
    // Hide modal
    hideClearConfirmation();
    
    // Update UI to reflect the cleared state
    updateAllUI();
    
    // [NEW] Show the undo button outside the modal
    const undoButton = document.getElementById('undoClearButton');
    if (undoButton) {
        undoButton.classList.remove('hidden');
    }
}

// New: Function to delete the currently viewed flight (if it exists in saved list)
function showDeleteCurrentFlightConfirmation() {
    const flightNumber = document.getElementById("flightNumber").value.trim();
    if (flightNumber && flightNumber !== "6E") {
        flightToDelete = flightNumber;
        document.getElementById("deleteCurrentFlightModalText").innerHTML = `Are you sure you want to delete the saved data for **${flightNumber}**? This cannot be undone.`;
        document.getElementById("deleteCurrentFlightConfirmationModal").style.display = "flex";
    } else {
        alert("Please enter a valid flight number (not 6E) to delete a saved flight.");
    }
}

function hideDeleteCurrentFlightConfirmation() {
    document.getElementById("deleteCurrentFlightConfirmationModal").style.display = "none";
    flightToDelete = null;
}

function confirmDeleteCurrentFlight() {
    if (flightToDelete) {
        const allFlightsData = JSON.parse(localStorage.getItem("allFlightsData")) || {};
        delete allFlightsData[flightToDelete];
        localStorage.setItem("allFlightsData", JSON.stringify(allFlightsData));
        
        // If the deleted flight was the one currently being viewed, clear the form too.
        const currentFlightNumber = document.getElementById("flightNumber").value.trim();
        if (currentFlightNumber === flightToDelete) {
            // Clear the form but ensure staff data remains
            clearConfirmedForm(true); // Don't re-save state for undo of a clear related to a delete
        }
        
        // Update the list of saved flights
        updateSavedFlightsList();
        
        hideDeleteCurrentFlightConfirmation();
        flightToDelete = null;
    }
}

// New: Functions for Delete All Saved Flights Modal
function showDeleteAllConfirmation() {
    const allFlightsData = JSON.parse(localStorage.getItem("allFlightsData")) || {};
    const flightNumbers = Object.keys(allFlightsData).reverse();
    const tableBody = document.getElementById("deleteFlightsTableBody");
    tableBody.innerHTML = '';
    document.getElementById("selectAllFlights").checked = false;
    document.getElementById("confirmDeleteSelectedBtn").disabled = true;
    document.getElementById("confirmDeleteSelectedBtn").classList.add("opacity-50", "cursor-not-allowed");
    
    if (flightNumbers.length === 0) {
        alert("No saved flights to delete.");
        return;
    }

    flightNumbers.forEach(flightNumber => {
        const row = tableBody.insertRow();
        row.innerHTML = `
            <td>${flightNumber}</td>
            <td>
                <label class="flex items-center justify-center cursor-pointer">
                    <input type="checkbox" class="flight-delete-checkbox" value="${flightNumber}" onclick="updateDeleteSelectedButton()">
                </label>
            </td>
        `;
    });
    
    document.getElementById("deleteAllConfirmationModal").style.display = "flex";
}

function hideDeleteAllConfirmation() {
    document.getElementById("deleteAllConfirmationModal").style.display = "none";
}

function toggleSelectAll(checkbox) {
    document.querySelectorAll(".flight-delete-checkbox").forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateDeleteSelectedButton();
}

function updateDeleteSelectedButton() {
    const checkedCount = document.querySelectorAll(".flight-delete-checkbox:checked").length;
    const button = document.getElementById("confirmDeleteSelectedBtn");
    
    if (checkedCount > 0) {
        button.disabled = false;
        button.classList.remove("opacity-50", "cursor-not-allowed");
    } else {
        button.disabled = true;
        button.classList.add("opacity-50", "cursor-not-allowed");
    }
}

function confirmDeleteSelected() {
    const checkboxes = document.querySelectorAll(".flight-delete-checkbox:checked");
    const flightsToDelete = Array.from(checkboxes).map(cb => cb.value);

    if (flightsToDelete.length === 0) {
        alert("No flights selected for deletion.");
        return;
    }

    const allFlightsData = JSON.parse(localStorage.getItem("allFlightsData")) || {};
    const currentFlightNumber = document.getElementById("flightNumber").value.trim();
    let currentFlightDeleted = false;
    
    flightsToDelete.forEach(flight => {
        if (allFlightsData[flight]) {
            delete allFlightsData[flight];
            if (flight === currentFlightNumber) {
                currentFlightDeleted = true;
            }
        }
    });

    localStorage.setItem("allFlightsData", JSON.stringify(allFlightsData));

    if (currentFlightDeleted) {
        // If the deleted flight was the one currently being viewed, clear the form too.
        clearConfirmedForm(true); // Don't re-save state for undo of a clear related to a delete
    }
    
    updateSavedFlightsList();
    hideDeleteAllConfirmation();
}

// --- UI Update and Helper Functions ---

// New: Function to manage floating labels on page load/restore
function setupFloatingLabels() {
    document.querySelectorAll(".form-input").forEach((input) => {
        const label = input.nextElementSibling;
        if (input.value.length > 0) {
            // Add floating class if value exists (simulates :not(:placeholder-shown))
            if (label && label.classList.contains('form-label')) {
                label.classList.add("floating");
            }
        } else {
            // Remove floating class if value is empty
            if (label && label.classList.contains('form-label')) {
                label.classList.remove("floating");
            }
        }
    });
}

// NEW: Function to toggle the visibility of the instruction tip
function updateTipVisibility() {
    const isFocusingTime = document.activeElement && 
                          (document.activeElement.id === 'co' || 
                           document.activeElement.id === 'ho' || 
                           document.activeElement.id === 'firstBag' || 
                           document.activeElement.id === 'lastBag');
                           
    const tipElement = document.querySelector('.col-span-full.mt-2.mb-4.text-xs.italic.text-gray-500.text-center');
    if (tipElement) {
        // Hide the tip if any time input is in focus, or keep it visible otherwise
        // However, the original prompt seems to imply showing it always as a tip.
        // Based on the original HTML, the tip is always visible. I'll stick to making 
        // no change to its visibility unless an explicit instruction was given to hide/show on focus,
        // which the JS snippet doesn't fully implement. The function exists, but the logic 
        // at the end of updateAllUI is simpler. Let's ensure the floating labels work.
    }
}

// Main function to update time differences, success/failure status, and delay reason UI
function updateAllUI() {
    const coInput = document.getElementById("co");
    const firstBagInput = document.getElementById("firstBag");
    const lastBagInput = document.getElementById("lastBag");
    const firstBagStatus = document.getElementById("firstBagStatus");
    const lastBagStatus = document.getElementById("lastBagStatus");
    const delayReasonSection = document.getElementById("delayReason").closest(".form-group");
    const statusContainer = document.getElementById("statusContainer");
    const undoButton = document.getElementById("undoClearButton");
    const addFlightButtonContainer = document.getElementById("addFlightButtonContainer");
    const flightNumber = document.getElementById("flightNumber").value.trim();

    // 1. Update Saved Flights List
    updateSavedFlightsList();

    // 2. Manage Flight Number "Save" button visibility
    if (flightNumber.length > 2 && flightNumber !== "6E") {
        addFlightButtonContainer.classList.remove("hidden");
    } else {
        addFlightButtonContainer.classList.add("hidden");
    }

    // 3. Manage Undo button visibility (after a manual clear)
    if (!lastClearedFormData && undoButton) {
        undoButton.classList.add('hidden');
    }

    // 4. Time calculations and UI updates
    const coTime = coInput.value;
    const firstBagTimeRaw = firstBagInput.value;
    const lastBagTimeRaw = lastBagInput.value;

    // Reset all status classes
    coInput.classList.remove("border-success", "border-failure");
    firstBagInput.classList.remove("border-success", "border-failure");
    lastBagInput.classList.remove("border-success", "border-failure");
    firstBagStatus.innerHTML = "";
    lastBagStatus.innerHTML = "";
    
    // --- First Bag Calculation (Time from CO to First Bag) ---
    if (coTime.length === 5 && firstBagTimeRaw.length === 5) {
        const timeDiff = calculateTimeDifference(coTime, firstBagTimeRaw);
        
        if (timeDiff !== null) {
            const isAchieved = timeDiff <= 10;
            
            // Update First Bag Input Border
            firstBagInput.classList.add(isAchieved ? "border-success" : "border-failure");
            
            // Update Status Text
            const icon = isAchieved ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check icon-success"><path d="M20 6 9 17l-5-5"/></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x icon-failure"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>';
            const statusClass = isAchieved ? 'icon-success' : 'icon-failure';
            
            firstBagStatus.innerHTML = `
                <div class="icon-with-text ${statusClass}">
                    ${icon}
                    <span>${timeDiff} min (${isAchieved ? 'Achieved' : 'Not Achieved'})</span>
                </div>
            `;
        }
    }

    // --- Last Bag Calculation (Time from CO to Last Bag) ---
    let totalTimeDiff = null;
    if (coTime.length === 5 && lastBagTimeRaw.length === 5) {
        totalTimeDiff = calculateTimeDifference(coTime, lastBagTimeRaw);
        
        if (totalTimeDiff !== null) {
            const isAchieved = totalTimeDiff <= 20;

            // Update Last Bag Input Border
            lastBagInput.classList.add(isAchieved ? "border-success" : "border-failure");
            
            // Update Status Text
            const icon = isAchieved ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check icon-success"><path d="M20 6 9 17l-5-5"/></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x icon-failure"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>';
            const statusClass = isAchieved ? 'icon-success' : 'icon-failure';

            lastBagStatus.innerHTML = `
                <div class="icon-with-text ${statusClass}">
                    ${icon}
                    <span>${totalTimeDiff} min (${isAchieved ? 'Achieved' : 'Not Achieved'})</span>
                </div>
            `;
        }
    }
    
    // --- Delay Reason and Overall Status Management ---
    if (coTime.length === 5 && lastBagTimeRaw.length === 5 && totalTimeDiff !== null) {
        // Both CO and Last Bag are fully entered (and valid time format)

        if (totalTimeDiff > 20) {
            // DELAYED
            delayReasonSection.style.display = "block";
            statusContainer.style.display = "block";
            
            // Update the Status Container with the "Not Achieved" message for the total time
            statusContainer.innerHTML = `
                <div class="font-bold text-red-600 text-sm">
                    Total Time Taken: ${totalTimeDiff} minutes. FB/LB Not Achieved.
                </div>
            `;
            
            // Enable Delay Reason text area and show options
            document.getElementById("delayReason").disabled = false;
            document.getElementById("delayReason").classList.remove("disabled-field");
            document.getElementById("delayReasonLabel").innerText = "Delay Reason (Required)";
            document.getElementById("delayReasonOptions").classList.remove("hidden");
            
        } else {
            // ACHIEVED
            // Hide Delay Reason section
            delayReasonSection.style.display = "block"; // Keep visible but with "NA" content
            
            // Update the Status Container with the "Achieved" message
            statusContainer.innerHTML = `
                <div class="font-bold text-green-600 text-sm">
                    Total Time Taken: ${totalTimeDiff} minutes. FB/LB Achieved.
                </div>
            `;
            
            // Disable Delay Reason text area and hide options
            statusContainer.style.display = "block";
            document.getElementById("delayReason").disabled = true;
            document.getElementById("delayReason").classList.add("disabled-field");
            document.getElementById("delayReasonLabel").innerText = "Delay Reason";
            document.getElementById("delayReasonOptions").classList.add("hidden");
            // Clear delay reason and checkboxes when delay is resolved (unless we are in the middle of an undo)
            if (!lastClearedFormData) {
                document.getElementById("delayReason").value = "";
                document
                    .querySelectorAll(".delay-reason-checkbox")
                    .forEach((checkbox) => {
                        checkbox.checked = false;
                    });
            }
        }
    } else {
        // Hide overall status and delay reason section if lastBag or co are not fully entered
        lastBagInput.classList.remove("border-success", "border-failure");
        delayReasonSection.style.display = "none";
        statusContainer.style.display = "none";
    }

    updateTipVisibility(); // <--- CALL TO NEW FUNCTION
}

["co", "firstBag", "lastBag"].forEach((id) => {
    document.getElementById(id).addEventListener("input", updateAllUI);
});
// Initial UI update on page load
document.addEventListener("DOMContentLoaded", () => {
    loadAllData();
    setupFloatingLabels();
    updateAllUI();
});
</script>
</body>
</html>
