<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Multi Quiz App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide/dist/umd/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        body {
            font-family: 'Poppins', sans-serif;
        }
        /* Custom styles for the progress ring SVG */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        /* Style for the answer buttons */
        .option-btn.selected {
            background-color: #4a5568;
            border: 2px solid #6366f1;
        }
        /* Style for the message box and modals */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        /* Sticky header */
        #quizStatusBar.sticky-top {
            position: sticky;
            top: 0;
            z-index: 20;
        }
        /* Style for the bar chart */
        .bar {
            background-color: #4f46e5;
            transition: height 0.5s ease-in-out;
            min-height: 5px;
            border-radius: 4px;
        }
        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #6366f1;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 60;
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div id="navbar" class="flex justify-between items-center bg-gray-800 p-4 shadow-lg sticky top-0 z-10">
        <h1 class="text-xl font-bold flex items-center gap-2">
            <i data-lucide="layers" class="h-6 w-6 text-indigo-400"></i> Multi Quiz App
        </h1>
        <div id="navbar-buttons" class="flex gap-2">
            <button id="mixQuizBtn" class="bg-gray-600 text-sm px-4 py-2 rounded-full hover:bg-gray-700 transition-colors duration-200 flex items-center gap-1">
                <i data-lucide="shuffle" class="h-4 w-4"></i> Mix Quiz
            </button>
            <button id="insightsBtn" class="bg-indigo-600 text-sm px-4 py-2 rounded-full hover:bg-indigo-700 transition-colors duration-200 flex items-center gap-1">
                <i data-lucide="bar-chart-3" class="h-4 w-4"></i> Insights
            </button>
        </div>
    </div>
    
    <div id="mainSection" class="p-4 grid grid-cols-2 gap-4 flex-grow">
    </div>

    <div id="insightsSection" class="hidden p-4 space-y-6 flex-grow">
        <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
            <i data-lucide="activity" class="h-6 w-6 text-indigo-400"></i> Dashboard
        </h2>

        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-8">
            <div class="relative w-40 h-40 flex-shrink-0">
                <svg class="w-full h-full" viewBox="0 0 100 100">
                    <circle 
                        class="text-gray-700"
                        stroke-width="10"
                        stroke="currentColor"
                        fill="transparent"
                        r="45"
                        cx="50"
                        cy="50"
                    />
                    <circle
                        id="progressCircle"
                        class="progress-ring__circle text-indigo-600"
                        stroke-width="10"
                        stroke-linecap="round"
                        stroke="currentColor"
                        fill="transparent"
                        r="45"
                        cx="50"
                        cy="50"
                    />
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                    <span id="overallAccuracy" class="text-3xl font-bold text-indigo-400">0%</span>
                    <span class="text-sm text-gray-400">Overall Accuracy</span>
                </div>
            </div>
            
            <div id="dashboardStats" class="grid grid-cols-2 gap-4 w-full md:w-auto">
            </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-2xl shadow-xl space-y-4">
            <h3 class="text-xl font-bold flex items-center gap-2">
                <i data-lucide="line-chart" class="h-5 w-5 text-indigo-400"></i> Quiz Accuracy
            </h3>
            <div id="quizBarChart" class="flex items-end justify-around h-40 space-x-2 w-full text-xs">
            </div>
            <p id="chartMessage" class="text-center text-gray-400 hidden">Start a quiz to see your progress!</p>
        </div>

        <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-red-400">
                <i data-lucide="alert-triangle" class="h-5 w-5"></i> Past Mistakes
            </h2>
            <select id="mistakesQuizSelector" class="w-full mb-4 px-3 py-2 rounded-lg text-black bg-gray-200">
                <option value="">-- Select Quiz --</option>
            </select>
            <div id="mistakesContainer" class="space-y-4"></div>
        </div>

        <button id="startNewQuizBtn" class="bg-indigo-600 px-6 py-2 rounded-full font-semibold hover:bg-indigo-700 transition-colors duration-200 w-full text-center">
            Start a new quiz
        </button>
    </div>

    <div id="quizSection" class="hidden p-6 space-y-6 flex-grow flex flex-col items-center justify-center">
        <div id="quizStatusBar" class="hidden bg-gray-800 bg-opacity-50 p-2 rounded-xl shadow-lg w-full max-w-4xl mb-6 flex items-center text-sm sticky-top">
            <button id="backBtn" class="bg-gray-600 p-2 rounded-full hover:bg-gray-700 transition-colors duration-200">
                <i data-lucide="chevron-left" class="h-5 w-5 text-white"></i>
            </button>
            <div class="flex-grow flex justify-around items-center">
                <p>Qs: <span id="qsAttempted" class="font-bold text-indigo-400">0</span></p>
                <p>Correct: <span id="qsCorrect" class="font-bold text-green-400">0</span></p>
                <p>Incorrect: <span id="qsIncorrect" class="font-bold text-red-400">0</span></p>
                <p>Accuracy: <span id="qsAccuracy" class="font-bold text-yellow-400">0%</span></p>
            </div>
        </div>

        <div id="questionsContainer" class="space-y-8 w-full max-w-2xl">
        </div>

        <button id="submitQuizBtn" class="mt-6 bg-indigo-600 px-8 py-3 rounded-full font-semibold hover:bg-indigo-700 transition-colors duration-200">
            Submit Quiz
        </button>
    </div>

    <div id="mixQuizModal" class="message-box hidden bg-gray-800 p-6 rounded-2xl shadow-xl w-full max-w-lg">
        <h3 class="text-2xl font-bold mb-4 text-center">Select Quizzes to Mix</h3>
        <div id="quizList" class="max-h-80 overflow-y-auto mb-4 p-2 rounded-md bg-gray-700 space-y-2">
        </div>
        <div class="flex justify-center gap-4 mt-6">
            <button id="startMixQuizBtn" class="bg-indigo-600 px-6 py-2 rounded-full font-semibold hover:bg-indigo-700 transition-colors duration-200">Start Mix Quiz (100 Qs)</button>
            <button id="cancelMixQuizBtn" class="bg-gray-600 px-6 py-2 rounded-full font-semibold hover:bg-gray-700 transition-colors duration-200">Cancel</button>
        </div>
    </div>

    <div id="messageBox" class="message-box hidden bg-gray-800 p-6 rounded-xl shadow-xl text-center w-80">
        <p id="messageText" class="text-white text-lg font-semibold mb-4"></p>
        <button id="messageBoxCloseBtn" class="bg-indigo-600 px-6 py-2 rounded-full font-semibold hover:bg-indigo-700 transition-colors duration-200">
            OK
        </button>
    </div>

    <div id="reattemptModal" class="message-box hidden bg-gray-800 p-6 rounded-xl shadow-xl text-center w-96">
        <h3 class="text-2xl font-bold mb-4">Reattempt Quiz</h3>
        <p class="text-white mb-4">Are you sure you want to reattempt the wrong/unattempted questions?</p>
        <div class="flex justify-center gap-4 mt-6">
            <button id="confirmReattemptBtn" class="bg-indigo-600 px-6 py-2 rounded-full font-semibold hover:bg-indigo-700 transition-colors duration-200">Yes</button>
            <button id="cancelReattemptBtn" class="bg-gray-600 px-6 py-2 rounded-full font-semibold hover:bg-gray-700 transition-colors duration-200">Cancel</button>
        </div>
    </div>

    <div id="quizSummaryModal" class="message-box hidden bg-gray-800 p-6 rounded-2xl shadow-2xl text-center w-full max-w-lg">
        <button id="closeSummaryModalBtn" class="absolute top-2 right-2 text-gray-400 hover:text-gray-200">
            <i data-lucide="x" class="h-6 w-6"></i>
        </button>
        <h3 class="text-2xl font-bold mb-4">Quiz Summary</h3>
        <div class="relative w-32 h-32 mx-auto mb-4">
            <svg class="w-full h-full" viewBox="0 0 100 100">
                <circle class="text-gray-700" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                <circle id="summaryProgressCircle" class="progress-ring__circle text-indigo-600" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
                <span id="summaryAccuracy" class="text-3xl font-bold text-indigo-400">0%</span>
            </div>
        </div>
        <div class="space-y-2 text-left mb-6">
            <p class="text-xl font-bold">Score: <span id="summaryScore" class="font-bold text-indigo-400">0/0</span></p>
            <p class="text-xl font-bold">Correct: <span id="summaryCorrect" class="font-bold text-green-400">0</span></p>
            <p class="text-xl font-bold">Incorrect: <span id="summaryIncorrect" class="font-bold text-red-400">0</span></p>
            <p class="text-xl font-bold">Unattempted: <span class="font-bold text-yellow-400">0</span></p>
        </div>
        <div class="flex flex-col md:flex-row justify-center gap-4 mt-6">
            <button id="resetQuizBtn" class="bg-gray-600 px-6 py-2 rounded-full font-semibold hover:bg-gray-700 transition-colors duration-200">Reset Quiz</button>
            <button id="reattemptWrongBtn" class="bg-indigo-600 px-6 py-2 rounded-full font-semibold hover:bg-indigo-700 transition-colors duration-200">Reattempt Wrong/Unattempted</button>
            <button id="quitQuizBtn" class="bg-red-600 px-6 py-2 rounded-full font-semibold hover:bg-red-700 transition-colors duration-200">Quit Quiz</button>
        </div>
    </div>

    <script>
        // Data for quizzes
        const quizzes = [
            { "name": "Basic 1", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vSkl3zFBB8s5jFoh3mNbRUbETM6k0FPkBwRmu9sRO-SSTFb5O-HaxPNACCjqOLgXEdzpVJxRYetJ4aO/pub?output=csv" },
            { "name": "Basic 2", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vSIpr6CpRW3F9kae8F3_cqqiXOtEL6CqCJlgsiJ79_l348bEsa2UWI93i4_chElLeG4JDNGSudflxf9/pub?output=csv" },
            { "name": "Basic 3", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQXg2KZDq8TtDq8xjVMNaveQXkhBrTIuxC-39EK1htO68FMKfEeLUfhqCNsacxSm6Vk5rg7eusQP_au/pub?output=csv" },
            { "name": "Basic 4", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTepTt61Dhntqokek0QH1fQK0Oo3lOI9qHbwHNGIbe2hk8vU3XHH2OiN1HyvoEwpY81Vi0ISOrqzYae/pub?output=csv" },
            { "name": "Basic 5", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRSnPYhv-vMmKL77c5XoirZGaqMjVyEppgq9Wp9S6GfDUvP1IiZRY2kZ6K2pT5LDPMXto1D1R3f2-Vu/pub?output=csv" },
            { "name": "Basic 6", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vSJUr0Br78XjprIIUkZhN94udUK9YhODYRLmLiKSkhz6ifqhh1PIshqv_ZaM6kpDumwy6V_oCmjNt9E/pub?output=csv" },
            { "name": "Basic 7", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRejjJTEmWGWXlrnOoUDSkAMm7P9GXRMd3wEpl2U3zk4Aua3NJLVhnFRAh8quK3-8FV-KbDr_RDz5-4/pub?output=csv" },
            { "name": "Basic 8", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQAEQfNB9GxnTAXPPhYQd4aN3Mjizk3WauJ-IoUGlSCG6MmQdZmtB896hFOPdDxWgkgJf739RWSCS0_/pub?output=csv" },
            { "name": "Basic 9", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRj1KcGeC1ZYQsmzEp3zOeDv4MgSAqSwkp7vjQh0b-R1o58gfScF25zz4K9UByc5PhYA4qZDSCA7OKw/pub?output=csv" },
            { "name": "Basic 10", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vSKKmIAXa0qs-dFO4njh3DmZGu5JoDTpfaZWOWXNtO5_DFz42YSATMwHCQ7v56MRJLIjp9QPZMOgM6X/pub?output=csv" },
            { "name": "Basic 11", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZEpBXKF8Rn67md2PhNTH4w-a0EG4ytYOuGdsjYSzSugSv3i3Q9SszT1OXeCYAt7HR4e2nAsO3bWp8/pub?output=csv" },
            { "name": "Terminologies", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vStq66g33WI6VxWrVx-l_eheqjxuOW2dYZTGDwQcxC4GrZpgUflUdUwuNqSiNTnyU4g8DklR2Cy7rOi/pub?output=csv" },
            { "name": "Abbreviations", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZDZq92XW_asvWanWZz0qqsB32f8XfJhxOR62bcfZDcGbvtX0LUbgRART2aiFdq59gIkT2A8Yu3zIS/pub?output=csv" },
            { "name": "Incidents", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT8WHfGycBq4rjzcjbtNrQUV6H4oU-YdfYO9Ci8V_xsEuguPQXYXODCau-If4U_82BqLrliYKErXGkV/pub?output=csv" },
            { "name": "Conventions", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXOLrIsbQ58dWOI6RDPQiJN27OCOvU_oeXFuH4wAHWHjo_oHQ-YKvepdJdZrABK6dlWA_tfT6l5CNN/pub?output=csv" },
            { "name": "Rules1937andAct1934", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2pcMHMF2YXQ91J9XVEtX7jOiZxf28oQ3jA7RqOc6qTsrZsJsYLwhkVW1X1wKWoB5MygkrdWpfXVmA/pub?output=csv" },
            { "name": "Circulars", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQaql9xRL5KFtTQmEG9r0UfmsnZne1zqMpLKn8quvJXFs-1De9vcwo741Z-be4trXcOHp_NaP5YVGJ2/pub?output=csv" },
            { "name": "Explosives", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTPwf4tOTuIDTAJVDg6w7OL5T_y4RfWxdCy687Wqd0ZnsqTMmVcYqV-D6hLCmpQTiKBPKrNAyjCjQLR/pub?output=csv" },
            { "name": "Module of 30 Q", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHAZU2pIQg0EM5wkypV6PiwbagA2-LweljvkfjW5SRhwHdR4eVYkIB19-d-rv3WXF3S9KpSyOykYv3/pub?output=csv" },
            { "name": "Mod 1", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTCpUs74l9QITASGdd7wO9mIW5ifcYvA8OV-2UNTW2N0_vI3tWGpGjbj6TXQhNdbi9yccnQnI2-2yEK/pub?output=csv" },
            { "name": "Mod 2", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRstO_Vbz7RSytJgBKaTVNHi4Dp8bXsKR58Z3vpWJY_weK6wFqw88YqmLOFwRCbodAQXEOYtt_fkqjE/pub?output=csv" },
            { "name": "Mod 3", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrJ0UfD-CvjdntSEm7TKHssI4Ui2Rylq-8R6E76iOgDm8M9AQgDhNo5EGsPmOzod7-HV7nW_4_e8gq/pub?output=csv" },
            { "name": "Mod 4", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTOAo2lp97mPkU63oD5nNxPbka4g2cJzTYcvN6bG6P535wrGs3UbXu5bbfeSdh0A5vny5Xq-qVtLot_/pub?output=csv" },
            { "name": "Mod 5", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vT6EbXzABp32AS4Ku7wbadAvjRPNa-Vwr_D1PrSZvVSDTQjW4IISoyKI5zkNiQggxcL5XDN6mOqJJ1k/pub?output=csv" },
            { "name": "Mod 6", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vQfaFlkYOGovauithx2HGcg0R1vyK0hJsXu86Cjz2KMKcN0-GjGvUAb9ZVrBDaTIONmvGiIUnx_sP8a/pub?output=csv" },
            { "name": "Mod 7", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vSkLEy6tGtzBHABNmdmc9-ZFBjhNObkVlNqZWXnG1SyPq19bYFJQI5gdJlgfppZyaV3uHlEKHpFqDG4/pub?output=csv" },
            { "name": "Contingency and Rest", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuTWEVJRYr-NsIrjKxdPsTaUblf7ZoLUL7CmGjEj9cvqaXopbzoszaOwW-Envs0vVjB563155wwREP/pub?output=csv" },
            { "name": "Screening And Profiling Plus Rest", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTsL8D-BXxylajwusK-O6afuasruhr04wmy-RpqDdVTDKYFRRShi9UR7GYk0pk2Z2yC_IfFDCUYwMF/pub?output=csv" },
            { "name": "MiscGeminiQuestions", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRJo0G6_xDZUSnjhzYlli9lYlEgRXyeJ0uJTdORBWlzSDPBou2vfIKzVnRhFCk7FQttF99TjdtESGyk/pub?output=csv" },
            { "name": "MiscGeminiQuestions2", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vSRvvLKsdFtaXwjxXu1cFnacBC6KVUz_jZXlzXKjXXwbOJkyGUHlcMyPzHxEBjMn963YMWv0ga21a/pub?output=csv" },
            { "name": "MiscGeminiQuestions3", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRc2vqEgsOS08H2kzmD_hzcUUzLtvd8OGk4LOFrQfGt9i0XN3oy2QhJDB5ASbEGIbOgDIk3yljqMGhU/pub?output=csv" },
            { "name": "Rules2023", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vTcla7Z19956dwDbDC5DBaAUEjkZ86AnZI5d8hh75bBYBZi8Wywpn4Sz4O6OBCyk7rDWxdr8eyqi0_R/pub?output=csv" },
            { "name": "ContingencyNew", "url": "https://docs.google.com/spreadsheets/d/e/2PACX-1vR-Wqco1ZH8FLR8iEjWH7PrWFQ-LQ2kLEzjZdDNMthVDJsqSJ8yuivLXX8qp8EetzqTElSuB1k7X5z_/pub?output=csv" }
        ];

        // Get DOM elements
        const navbar = document.getElementById("navbar");
        const mainSection = document.getElementById("mainSection");
        const insightsSection = document.getElementById("insightsSection");
        const insightsBtn = document.getElementById("insightsBtn");
        const mixQuizBtn = document.getElementById("mixQuizBtn");
        const backBtn = document.getElementById("backBtn");
        const dashboardStats = document.getElementById("dashboardStats");
        const overallAccuracySpan = document.getElementById("overallAccuracy");
        const progressCircle = document.getElementById("progressCircle");
        const mistakesQuizSelector = document.getElementById("mistakesQuizSelector");
        const mistakesContainer = document.getElementById("mistakesContainer");
        const quizBarChart = document.getElementById("quizBarChart");
        const chartMessage = document.getElementById("chartMessage");
        const quizSection = document.getElementById("quizSection");
        const questionsContainer = document.getElementById("questionsContainer");
        const quizStatusBar = document.getElementById("quizStatusBar");
        const qsAttemptedEl = document.getElementById("qsAttempted");
        const qsCorrectEl = document.getElementById("qsCorrect");
        const qsIncorrectEl = document.getElementById("qsIncorrect");
        const qsAccuracyEl = document.getElementById("qsAccuracy");
        const mixQuizModal = document.getElementById("mixQuizModal");
        const quizList = document.getElementById("quizList");
        const startMixQuizBtn = document.getElementById("startMixQuizBtn");
        const cancelMixQuizBtn = document.getElementById("cancelMixQuizBtn");
        const messageBox = document.getElementById("messageBox");
        const messageText = document.getElementById("messageText");
        const messageBoxCloseBtn = document.getElementById("messageBoxCloseBtn");
        const startNewQuizBtn = document.getElementById("startNewQuizBtn");
        const submitQuizBtn = document.getElementById("submitQuizBtn");
        const quizSummaryModal = document.getElementById("quizSummaryModal");
        const closeSummaryModalBtn = document.getElementById("closeSummaryModalBtn");
        const summaryScoreEl = document.getElementById("summaryScore");
        const summaryCorrectEl = document.getElementById("summaryCorrect");
        const summaryIncorrectEl = document.getElementById("summaryIncorrect");
        const summaryUnattemptedEl = document.getElementById("summaryUnattempted");
        const summaryAccuracyEl = document.getElementById("summaryAccuracy");
        const summaryProgressCircle = document.getElementById("summaryProgressCircle");
        const resetQuizBtn = document.getElementById("resetQuizBtn");
        const reattemptWrongBtn = document.getElementById("reattemptWrongBtn");
        const reattemptModal = document.getElementById("reattemptModal");
        const confirmReattemptBtn = document.getElementById("confirmReattemptBtn");
        const cancelReattemptBtn = document.getElementById("cancelReattemptBtn");
        const quitQuizBtnSummary = document.getElementById("quitQuizBtn");
        const loadingOverlay = document.getElementById("loadingOverlay");

        // State variables for the current quiz
        let currentQuizName = '';
        let quizQuestions = [];
        let score = 0;
        let mistakes = [];
        let attemptedCount = 0;
        let totalQuestions = 0;
        let originalQuizData = null; // Store the initial quiz data for reattempts

        // Utility function to shuffle an array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            renderQuizCards();
            lucide.createIcons();
        });
        // Function to show custom message box
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        // Function to hide custom message box
        messageBoxCloseBtn.onclick = () => {
            messageBox.classList.add('hidden');
        };

        function renderQuizCards() {
            mainSection.innerHTML = "";
            const allQuizzes = [...quizzes, { name: "Mixed Quiz", url: "" }];
            allQuizzes.forEach(q => {
                const stats = JSON.parse(localStorage.getItem(q.name + "_stats")) || { attempted: 0, correct: 0, total: 0 };
                let progress = null;
                try {
                    progress = JSON.parse(localStorage.getItem(q.name + "_progress"));
                } catch (e) {
                    console.error("Failed to parse progress data. Starting new quiz.", e);
                    localStorage.removeItem(q.name + "_progress");
                }
                const accuracy = stats.attempted ? Math.round((stats.correct / stats.attempted) * 100) : 0;
                
                let cardClass = "bg-gray-800";
                let buttonText = "Start";
                let buttonAction;

                if (progress) {
                    // Incomplete quiz with saved progress
                    buttonText = "Resume";
                    buttonAction = () => startQuiz(q.name, q.url);
                } else if (stats.attempted === stats.total && stats.total > 0) {
                    // All questions attempted
                    cardClass = "bg-green-700";
                    buttonText = "Restart";
                    buttonAction = () => startQuiz(q.name, q.url, true);
                } else if (q.name === "Mixed Quiz") {
                    // Mixed quiz has no dedicated start button
                    buttonText = "";
                    buttonAction = () => {};
                } else {
                    // New quiz, no progress saved
                    buttonAction = () => startQuiz(q.name, q.url, true);
                }
                
                const card = document.createElement("div");
                card.className = `${cardClass} p-4 rounded-xl shadow-lg flex flex-col justify-between transform transition-transform hover:scale-105`;
                
                const buttonHtml = buttonText ?
                `
                    <button class="flex-1 bg-indigo-600 py-1 rounded-full hover:bg-indigo-700 transition-colors duration-200">${buttonText}</button>
                ` : `<span class="text-xs text-gray-400">Use "Mix Quiz" button above</span>`;
                card.innerHTML = `
                    <h2 class="text-sm md:text-md font-bold mb-2 truncate"><i data-lucide="file-text" class="inline-block mr-1 h-4 w-4 text-purple-400"></i> ${q.name}</h2>
                    <div class="text-xs text-gray-400 mb-4">
                        <p>Progress: <span class="font-semibold">${stats.attempted}/${stats.total}</span></p>
                        <p>Accuracy: <span class="font-semibold">${accuracy}%</span></p>
                    </div>
                    <div class="flex gap-2 mt-auto text-sm">
                        ${buttonHtml}
                    </div>
                `;
                mainSection.appendChild(card);
                if (buttonText && q.name !== "Mixed Quiz") {
                    card.querySelector("button").onclick = buttonAction;
                }
            });
            lucide.createIcons();
        }

        async function fetchQuizData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                return parseCSV(csvText);
            } catch (error) {
                showMessageBox(`Failed to load quiz data: ${error.message}`);
                return null;
            }
        }

        function parseCSV(text) {
            // Normalize newlines and split into lines, filtering out empty ones
            const lines = text.replace(/\r\n/g, '\n').split('\n').filter(line => line.trim() !== '');
            if (lines.length <= 1) return []; // Only header row

            const questions = [];
            
            // Start from the second line to skip the header
            for (let i = 1; i < lines.length; i++) {
                let line = lines[i];
                if (line.trim() === '') continue;

                const fields = [];
                let inQuote = false;
                let field = '';

                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    const nextChar = line[j + 1];

                    // Handle escaped quotes `""` inside a quoted field
                    if (char === '"' && inQuote && nextChar === '"') {
                        field += '"';
                        j++; // Skip the next character
                    } else if (char === '"') {
                        // Toggle quote state
                        inQuote = !inQuote;
                    } else if (char === ',' && !inQuote) {
                        // End of a field
                        fields.push(field.trim());
                        field = '';
                    } else {
                        field += char;
                    }
                }
                // Push the last field
                fields.push(field.trim());

                // Assuming a question has at least 7 columns (index 0 to 6)
                // Check for the minimum required fields
                if (fields.length >= 7) {
                    const questionText = fields[1];
                    // Ensure the question text is not empty
                    if (questionText.trim() !== '') {
                        questions.push({
                            question: questionText,
                            options: [fields[2], fields[3], fields[4], fields[5]].filter(o => o.trim() !== ''),
                            answer: fields[6],
                            userAnswer: null,
                            isCorrect: null
                        });
                    }
                }
            }
            return questions;
        }

        async function startQuiz(name, url, isNewStart = false) {
            currentQuizName = name;
            
            let savedProgress = null;
            try {
                savedProgress = JSON.parse(localStorage.getItem(currentQuizName + "_progress"));
            } catch (e) {
                console.error("Failed to parse progress data. Starting new quiz.", e);
                localStorage.removeItem(currentQuizName + "_progress");
            }
            
            let lastQuestionIndex = 0;
            
            if (isNewStart || !savedProgress) {
                loadingOverlay.style.display = 'flex';
                const data = await fetchQuizData(url);
                loadingOverlay.style.display = 'none';

                if (!data || data.length === 0) {
                    showMessageBox("No questions found for this quiz.");
                    return;
                }

                shuffleArray(data);
                quizQuestions = data;
                originalQuizData = JSON.parse(JSON.stringify(data));
                totalQuestions = quizQuestions.length;
                score = 0;
                mistakes = [];
                attemptedCount = 0;
                localStorage.removeItem(currentQuizName + "_progress");
            } else {
                quizQuestions = savedProgress.quizQuestions;
                // Use the loaded quizQuestions as the source of truth
                originalQuizData = quizQuestions; 
                totalQuestions = savedProgress.totalQuestions;
                score = savedProgress.score;
                mistakes = savedProgress.mistakes;
                attemptedCount = savedProgress.attemptedCount;
                lastQuestionIndex = attemptedCount;
            }
            
            mainSection.classList.add('hidden');
            insightsSection.classList.add('hidden');
            navbar.classList.add('hidden');
            quizSection.classList.remove('hidden');
            quizStatusBar.classList.remove('hidden');
            
            renderQuestions();
            updateStatusBar();

            if (!isNewStart && lastQuestionIndex > 0) {
                setTimeout(() => {
                    const lastQuestionCard = document.getElementById(`question-card-${lastQuestionIndex - 1}`);
                    if (lastQuestionCard) {
                        lastQuestionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            } else {
                window.scrollTo(0, 0);
            }
        }

        function saveProgress() {
            // Save only the essential data to prevent exceeding local storage limits.
            // originalQuizData is no longer needed as a separate object.
            const progress = {
                quizQuestions: quizQuestions,
                score: score,
                mistakes: mistakes,
                attemptedCount: attemptedCount,
                totalQuestions: totalQuestions
            };
            localStorage.setItem(currentQuizName + "_progress", JSON.stringify(progress));
        }

        function updateStatusBar() {
            qsAttemptedEl.textContent = attemptedCount;
            qsCorrectEl.textContent = score;
            qsIncorrectEl.textContent = mistakes.length;
            const accuracy = attemptedCount ? Math.round((score / attemptedCount) * 100) : 0;
            qsAccuracyEl.textContent = `${accuracy}%`;
        }

        function renderQuestions() {
            questionsContainer.innerHTML = '';
            quizQuestions.forEach((q, index) => {
                const questionCard = document.createElement('div');
                questionCard.id = `question-card-${index}`;
                questionCard.className = "question-card bg-gray-800 p-6 rounded-2xl shadow-xl w-full space-y-4";
                
                const questionNumber = document.createElement('div');
                questionNumber.className = "text-sm text-gray-400 mb-2";
                questionNumber.textContent = `Question ${index + 1} of ${quizQuestions.length}`;

                const questionText = document.createElement('div');
                questionText.className = "text-xl font-semibold mb-4";
                questionText.textContent = q.question;

                const optionsContainer = document.createElement('div');
                optionsContainer.className = "grid grid-cols-1 md:grid-cols-2 gap-4";
                
                q.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = "option-btn bg-gray-700 p-4 rounded-xl text-left w-full hover:bg-gray-600 transition-colors duration-200";
                    button.textContent = option;
                    button.onclick = () => checkAnswer(q.question, button, option);
                    optionsContainer.appendChild(button);
                });

                const feedback = document.createElement('div');
                feedback.id = `feedback-${index}`;
                feedback.className = "mt-4 text-center hidden text-lg font-bold";

                questionCard.appendChild(questionNumber);
                questionCard.appendChild(questionText);
                questionCard.appendChild(optionsContainer);
                questionCard.appendChild(feedback);
                questionsContainer.appendChild(questionCard);
                if (q.userAnswer) {
                    const selectedBtn = Array.from(optionsContainer.querySelectorAll('.option-btn')).find(btn => btn.textContent === q.userAnswer);
                    if (selectedBtn) {
                        checkAnswer(q.question, selectedBtn, q.userAnswer, true);
                    }
                }
            });
        }
        
        function checkAnswer(questionText, selectedBtn, userAnswer, isResume = false) {
            const originalQ = originalQuizData.find(q => q.question === questionText);
            if (!originalQ) return;

            const questionCard = selectedBtn.closest('.question-card');
            const optionButtons = questionCard.querySelectorAll('.option-btn');
            const feedbackEl = questionCard.querySelector('[id^="feedback-"]');
            const alreadyAnswered = originalQ.userAnswer !== null;
            if (alreadyAnswered && !isResume) {
                return;
            }

            let actualCorrectAnswer;
            if (!isNaN(originalQ.answer) && parseInt(originalQ.answer) >= 1 && parseInt(originalQ.answer) <= 4) {
                actualCorrectAnswer = originalQ.options[parseInt(originalQ.answer) - 1];
            } else {
                actualCorrectAnswer = originalQ.answer;
            }
            
            const isCorrect = (userAnswer === actualCorrectAnswer);
            originalQ.userAnswer = userAnswer;
            originalQ.isCorrect = isCorrect;
            
            score = originalQuizData.filter(q => q.isCorrect).length;
            mistakes = originalQuizData.filter(q => q.userAnswer && !q.isCorrect).map(q => ({
                question: q.question,
                userAnswer: q.userAnswer,
                correctAnswer: q.correctAnswer
            }));
            attemptedCount = originalQuizData.filter(q => q.userAnswer).length;
            
            optionButtons.forEach(btn => {
                if (btn.textContent === actualCorrectAnswer) {
                    btn.classList.add('bg-green-600');
                    btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                } else if (btn.textContent === userAnswer) {
                    btn.classList.add('bg-red-600');
                    btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                }
                btn.disabled = true;
            });
            feedbackEl.classList.remove('hidden');
            if (isCorrect) {
                feedbackEl.textContent = 'Correct!';
                feedbackEl.classList.remove('text-red-400');
                feedbackEl.classList.add('text-green-400');
            } else {
                feedbackEl.textContent = 'Incorrect!';
                feedbackEl.classList.remove('text-green-400');
                feedbackEl.classList.add('text-red-400');
            }

            updateStatusBar();
            updateInsightsData(currentQuizName, {
                attempted: attemptedCount,
                correct: score,
                incorrect: mistakes.length,
                total: totalQuestions
            });
            saveProgress();

            if (!isResume) {
                const questionIndex = quizQuestions.findIndex(q => q.question === questionText);
                scrollToNextQuestion(questionIndex);
            }
        }

        function updateStatusBarDisplay(attempted, correct, incorrect) {
            qsAttemptedEl.textContent = attempted;
            qsCorrectEl.textContent = correct;
            qsIncorrectEl.textContent = incorrect;
            const accuracy = attempted ? Math.round((correct / attempted) * 100) : 0;
            qsAccuracyEl.textContent = `${accuracy}%`;
        }
        function updateStatusBar() {
            qsAttemptedEl.textContent = attemptedCount;
            qsCorrectEl.textContent = score;
            qsIncorrectEl.textContent = mistakes.length;
            const accuracy = attemptedCount ? Math.round((score / attemptedCount) * 100) : 0;
            qsAccuracyEl.textContent = `${accuracy}%`;
        }

        function scrollToNextQuestion(currentIndex) {
            const nextIndex = currentIndex + 1;
            const nextQuestionCard = document.getElementById(`question-card-${nextIndex}`);
            if (nextQuestionCard) {
                setTimeout(() => {
                    nextQuestionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
        }

        function updateInsightsData(name, stats) {
            const fullStats = JSON.parse(localStorage.getItem(name + "_stats")) || { total: stats.total, attempted: 0, correct: 0, incorrect: 0, unattempted: stats.total };
            
            fullStats.attempted = stats.attempted;
            fullStats.correct = stats.correct;
            fullStats.incorrect = stats.incorrect;
            fullStats.unattempted = stats.unattempted;
            
            localStorage.setItem(name + "_stats", JSON.stringify(fullStats));
            fullStats.mistakes = mistakes.length;
            if (name !== 'Mixed Quiz') {
                localStorage.setItem(name + "_mistakes", JSON.stringify(mistakes));
            }
            
            renderQuizCards();
        }

        function endQuiz() {
            const finalStats = {
                correct: originalQuizData.filter(q => q.isCorrect).length,
                incorrect: originalQuizData.filter(q => q.userAnswer && !q.isCorrect).length,
                unattempted: originalQuizData.filter(q => q.userAnswer === null).length,
                total: totalQuestions,
                attempted: originalQuizData.filter(q => q.userAnswer).length
            };
            updateInsightsData(currentQuizName, finalStats);
            
            summaryScoreEl.textContent = `${finalStats.correct}/${finalStats.total}`;
            summaryCorrectEl.textContent = finalStats.correct;
            summaryIncorrectEl.textContent = finalStats.incorrect;
            summaryUnattemptedEl.textContent = finalStats.unattempted;
            const accuracy = finalStats.attempted > 0 ? Math.round((finalStats.correct / finalStats.attempted) * 100) : 0;
            summaryAccuracyEl.textContent = `${accuracy}%`;

            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (accuracy / 100) * circumference;
            summaryProgressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            summaryProgressCircle.style.strokeDashoffset = offset;

            quizSummaryModal.classList.remove('hidden');
            quizSection.classList.add('hidden');
            navbar.classList.remove('hidden');
            quizStatusBar.classList.add('hidden');

            localStorage.removeItem(currentQuizName + "_progress");
            renderQuizCards();
        }

        function renderDashboard() {
            let totalQuizzes = quizzes.length;
            let attemptedQuizzes = 0;
            let totalQ = 0, totalA = 0, totalC = 0;

            const quizAccuracies = [];
            const allQuizData = [...quizzes, { name: "Mixed Quiz", url: "" }];
            allQuizData.forEach(q => {
                const s = JSON.parse(localStorage.getItem(q.name + "_stats")) || {};
                if (s.total > 0) {
                    attemptedQuizzes++;
                    const quizAccuracy = s.attempted > 0 ? Math.round((s.correct / s.attempted) * 100) : 0;
                    quizAccuracies.push({ name: q.name, accuracy: quizAccuracy });
                }
                totalQ += s.total || 0;
                totalA += s.attempted || 0;
                totalC += s.correct || 0;
            });
            
            quizBarChart.innerHTML = '';
            if (quizAccuracies.length === 0) {
                chartMessage.classList.remove('hidden');
            } else {
                chartMessage.classList.add('hidden');
                quizAccuracies.forEach(quiz => {
                    const barHeight = quiz.accuracy > 0 ? quiz.accuracy : 5;
                    const bar = document.createElement('div');
                    bar.className = 'flex flex-col items-center justify-end h-full';
                    bar.innerHTML = `
                        <div class="text-xs font-bold mb-1">${quiz.accuracy}%</div>
                        <div class="bar w-8" style="height: ${barHeight}%;"></div>
                        <div class="mt-2 text-center text-gray-400 text-[10px] w-12 truncate">${quiz.name}</div>
                    `;
                    quizBarChart.appendChild(bar);
                });
            }

            const overallAccuracy = totalA > 0 ? Math.round((totalC / totalA) * 100) : 0;

            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (overallAccuracy / 100) * circumference;
            progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            progressCircle.style.strokeDashoffset = offset;
            overallAccuracySpan.textContent = `${overallAccuracy}%`;
            const stats = [
                { title: 'Quizzes', value: attemptedQuizzes, icon: 'check-circle', color: 'text-green-400' },
                { title: 'Questions', value: totalA, icon: 'help-circle', color: 'text-yellow-400' },
                { title: 'Correct', value: totalC, icon: 'award', color: 'text-indigo-400' },
                { title: 'Incorrect', value: totalA - totalC, icon: 'x-circle', color: 'text-red-400' }
            ];
            dashboardStats.innerHTML = stats.map(s => `
                <div class="bg-gray-700 p-4 rounded-xl shadow-md flex flex-col items-start justify-center text-left space-y-1">
                    <i data-lucide="${s.icon}" class="h-6 w-6 ${s.color}"></i>
                    <h3 class="text-lg font-bold">${s.value}</h3>
                    <p class="text-gray-400 text-sm">${s.title}</p>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function populateMistakesSelector() {
            mistakesQuizSelector.innerHTML = '<option value="">-- Select Quiz --</option>';
            quizzes.forEach(q => {
                const s = JSON.parse(localStorage.getItem(q.name + "_stats")) || {};
                if (s.total > 0 && q.name !== 'Mixed Quiz') {
                    mistakesQuizSelector.innerHTML += `<option value="${q.name}">${q.name}</option>`;
                }
            });
        }

        mistakesQuizSelector.addEventListener("change", () => {
            mistakesContainer.innerHTML = "";
            const qid = mistakesQuizSelector.value;
            if (!qid) return;

            const mistakes = JSON.parse(localStorage.getItem(qid + "_mistakes")) || [];
            if (mistakes.length === 0) {
                mistakesContainer.innerHTML = "<p class='text-gray-400 text-center'>No mistakes recorded for this quiz.</p>";
                return;
            }

            mistakes.forEach((m, i) => {
                const box = document.createElement("div");
                box.className = "bg-gray-700 p-4 rounded-lg shadow-md";
                box.innerHTML = `
                    <p class="font-semibold mb-2 text-sm text-gray-200">Q${i + 1}: ${m.question}</p>
                    <p class="text-red-400 text-xs">Your Answer: ${m.userAnswer}</p>
                    <p class="text-green-400 text-xs">Correct Answer: ${m.correctAnswer}</p>
                `;
                mistakesContainer.appendChild(box);
            });
        });
        insightsBtn.onclick = () => {
            const showingInsights = !insightsSection.classList.contains("hidden");
            if (showingInsights) {
                insightsSection.classList.add("hidden");
                mainSection.classList.remove("hidden");
                insightsBtn.innerHTML = `<i data-lucide="bar-chart-3" class="h-4 w-4"></i> Insights`;
                lucide.createIcons();
            } else {
                renderDashboard();
                populateMistakesSelector();
                insightsSection.classList.remove("hidden");
                mainSection.classList.add("hidden");
                insightsBtn.innerHTML = `<i data-lucide="grid" class="h-4 w-4"></i> Quizzes`;
                lucide.createIcons();
            }
        };
        backBtn.onclick = () => {
            saveProgress();
            quizSection.classList.add('hidden');
            insightsSection.classList.add('hidden');
            mainSection.classList.remove('hidden');
            navbar.classList.remove('hidden');
            quizStatusBar.classList.add('hidden');
            window.scrollTo(0, 0);
            renderQuizCards();
        };

        startNewQuizBtn.onclick = () => {
            mainSection.classList.remove("hidden");
            insightsSection.classList.add("hidden");
            navbar.classList.remove('hidden');
            insightsBtn.innerHTML = `<i data-lucide="bar-chart-3" class="h-4 w-4"></i> Insights`;
            lucide.createIcons();
        };
        submitQuizBtn.onclick = () => {
            endQuiz();
        };
        closeSummaryModalBtn.onclick = () => {
            quizSummaryModal.classList.add('hidden');
        };
        resetQuizBtn.onclick = () => {
            quizSummaryModal.classList.add('hidden');
            startQuiz(currentQuizName, quizzes.find(q => q.name === currentQuizName).url, true);
        };

        reattemptWrongBtn.onclick = () => {
            quizSummaryModal.classList.add('hidden');
            reattemptModal.classList.remove('hidden');
        };

        confirmReattemptBtn.onclick = () => {
            reattemptModal.classList.add('hidden');
            const fullProgress = JSON.parse(localStorage.getItem(currentQuizName + "_progress"));
            const originalQuizQuestions = fullProgress.originalQuizData;
            
            const wrongAndUnattempted = originalQuizQuestions.filter(q => q.userAnswer === null || !q.isCorrect);
            shuffleArray(wrongAndUnattempted);

            quizQuestions = wrongAndUnattempted;
            score = fullProgress.score;
            mistakes = fullProgress.mistakes;
            attemptedCount = fullProgress.attemptedCount;
            totalQuestions = fullProgress.totalQuestions;
            
            mainSection.classList.add('hidden');
            insightsSection.classList.add('hidden');
            navbar.classList.add('hidden');
            quizSection.classList.remove('hidden');
            quizStatusBar.classList.remove('hidden');
            
            renderQuestions();
            updateStatusBar();
            window.scrollTo(0, 0);
        };
        cancelReattemptBtn.onclick = () => {
            reattemptModal.classList.add('hidden');
            quizSummaryModal.classList.remove('hidden');
        };
        quitQuizBtnSummary.onclick = () => {
            saveProgress();
            quizSection.classList.add('hidden');
            quizSummaryModal.classList.add('hidden');
            mainSection.classList.remove('hidden');
            navbar.classList.remove('hidden');
            quizStatusBar.classList.add('hidden');
            window.scrollTo(0, 0);
            renderQuizCards();
        };

        mixQuizBtn.onclick = () => {
            quizList.innerHTML = '';
            quizzes.forEach((q, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-2';
                item.innerHTML = `
                    <input type="checkbox" id="quiz-${index}" name="quiz-select" value="${q.name}" data-url="${q.url}" class="form-checkbox text-indigo-600 rounded-sm bg-gray-600 border-gray-500">
                    <label for="quiz-${index}" class="text-sm font-medium text-white">${q.name}</label>
                `;
                quizList.appendChild(item);
            });
            mixQuizModal.classList.remove('hidden');
        };

        cancelMixQuizBtn.onclick = () => {
            mixQuizModal.classList.add('hidden');
        };
        startMixQuizBtn.onclick = async () => {
            const selectedQuizzes = Array.from(document.querySelectorAll('input[name="quiz-select"]:checked'));
            if (selectedQuizzes.length === 0) {
                showMessageBox("Please select at least one quiz to mix.");
                return;
            }

            mixQuizModal.classList.add('hidden');
            loadingOverlay.style.display = 'flex';
            const allQuestions = [];
            const questionsPerQuiz = Math.floor(100 / selectedQuizzes.length);
            let remainingQuestions = 100 % selectedQuizzes.length;
            for (const checkbox of selectedQuizzes) {
                const quizUrl = checkbox.dataset.url;
                const questions = await fetchQuizData(quizUrl);

                if (questions) {
                    shuffleArray(questions);
                    let numToTake = questionsPerQuiz;
                    if (remainingQuestions > 0) {
                        numToTake++;
                        remainingQuestions--;
                    }
                    allQuestions.push(...questions.slice(0, numToTake));
                }
            }

            shuffleArray(allQuestions);
            loadingOverlay.style.display = 'none';

            currentQuizName = 'Mixed Quiz';
            quizQuestions = allQuestions;
            originalQuizData = allQuestions;
            totalQuestions = quizQuestions.length;
            score = 0;
            mistakes = [];
            attemptedCount = 0;
            localStorage.removeItem(currentQuizName + "_progress");

            mainSection.classList.add('hidden');
            insightsSection.classList.add('hidden');
            navbar.classList.add('hidden');
            quizSection.classList.remove('hidden');
            quizStatusBar.classList.remove('hidden');
            
            renderQuestions();
            updateStatusBar();
            window.scrollTo(0, 0);
        };
    </script>
</body>
</html>
